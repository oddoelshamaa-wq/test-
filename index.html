<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP SYSTEM V44.0 | ULTIMATE ANALYTICS</title>
    
    <!-- 
        ========================================================================
        --- GLOBAL EXTERNAL INFRASTRUCTURE ---
        ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù‚ÙˆØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„ÙØ§Ø¦Ù‚Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        ========================================================================
    -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙŠÙ… ÙÙˆÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* 
           ========================================================================
           --- CSS MASTER ARCHITECTURE: VIP ETERNAL DESIGN --- 
           ØªÙ… ØªØµÙ…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø«ÙŠÙ… Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¶Ø®Ù… ÙˆØ§Ù„Ø£Ø¬Ù…Ù„ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù…Ø¹ ÙƒØ«Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ© Ø¹Ø§Ù„ÙŠØ©
           ========================================================================
        */
        :root {
            --primary-bg-core: #010409;
            --glass-surface: rgba(13, 17, 23, 0.96);
            --gold-master: #f59e0b;
            --gold-bright: #fbbf24;
            --accent-navy: #1d4ed8;
            --success-glow: #10b981;
            --danger-pulse: #ef4444;
            --text-pure: #f0f6fc;
            --text-muted-core: #8b949e;
            --border-glow-line: rgba(245, 158, 11, 0.28);
            --radius-massive: 28px;
            --shadow-depth: 0 40px 80px rgba(0,0,0,0.85), inset 0 1px 2px rgba(255,255,255,0.06);
            --font-stack: 'Cairo', sans-serif;
            --transition-speed: 0.35s;
        }

        /* --- Global Smooth Animation Keyframes --- */
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes borderPulseGlow { 0% { border-color: rgba(245, 158, 11, 0.2); } 50% { border-color: rgba(245, 158, 11, 0.6); } 100% { border-color: rgba(245, 158, 11, 0.2); } }
        @keyframes rotateBrand { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Scrollbar Performance Design --- */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--primary-bg-core); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--gold-master), #d97706); border-radius: 12px; border: 3px solid var(--primary-bg-core); }

        * {
            box-sizing: border-box;
            outline: none;
            margin: 0;
            padding: 0;
            transition: var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: var(--font-stack);
            background: var(--primary-bg-core);
            color: var(--text-pure);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 15px;
            background-image: 
                radial-gradient(circle at 5% 5%, rgba(245, 158, 11, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 95% 95%, rgba(29, 78, 216, 0.1) 0%, transparent 50%);
            background-attachment: fixed;
        }

        /* --- Layout Container Hub --- */
        .vip-master-container {
            max-width: 1950px;
            margin: 0 auto;
            padding: 50px;
            animation: slideUpFade 0.7s ease-out;
        }

        .massive-glass-card {
            background: var(--glass-surface);
            backdrop-filter: blur(55px);
            border: 1px solid var(--border-glow-line);
            border-radius: var(--radius-massive);
            box-shadow: var(--shadow-depth);
            position: relative;
            overflow: hidden;
        }

        /* --- Navigation Architecture --- */
        .system-top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 35px 70px;
            margin-bottom: 60px;
            position: sticky;
            top: 30px;
            z-index: 1000;
            border-bottom: 2.5px solid var(--border-glow-line);
        }

        .identity-matrix {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .identity-orb-vip {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, var(--gold-master), #b45309);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 950;
            color: #000;
            font-size: 2.5rem;
            border: 6px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.5);
            cursor: pointer;
        }

        .identity-orb-vip:hover { animation: rotateBrand 2s infinite linear; }

        .identity-labels h2 { font-size: 2rem; letter-spacing: 0.8px; font-weight: 900; }
        .identity-labels p { color: var(--gold-master); font-weight: 800; font-size: 1rem; margin-top: 5px; }

        .nav-hub-menu { display: flex; gap: 20px; }
        
        .nav-link-vip {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-glow-line);
            color: var(--text-muted-core);
            padding: 18px 40px;
            border-radius: 22px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-weight: 900;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-link-vip:hover, .nav-link-vip.active {
            background: var(--gold-master);
            color: #000;
            transform: translateY(-8px);
            box-shadow: 0 20px 45px rgba(245, 158, 11, 0.6);
        }

        /* --- Floating Command Center --- */
        .floating-action-master {
            position: fixed;
            bottom: 80px;
            left: 80px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gold-master);
            color: #000;
            font-size: 4.5rem;
            border: none;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 40px 90px rgba(245, 158, 11, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .floating-action-master:hover { transform: scale(1.2) rotate(90deg); }

        /* --- Sidebar Panel Core --- */
        .sidebar-complaint-master {
            position: fixed;
            top: 0;
            right: -700px;
            width: 650px;
            height: 100%;
            background: #0b0e14;
            border-left: 12px solid var(--gold-master);
            z-index: 2600;
            padding: 70px;
            transition: 1s cubic-bezier(0.7, 0, 0.1, 1);
            box-shadow: -60px 0 200px rgba(0,0,0,1);
            overflow-y: auto;
        }

        .sidebar-complaint-master.open { right: 0; }

        .dimmer-overlay-master {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 2599;
            display: none;
        }

        /* --- Ticket Presentation UI --- */
        .ticket-visual-unit {
            padding: 65px;
            border-radius: var(--radius-massive);
            border-right: 22px solid var(--gold-master);
            margin-bottom: 55px;
            background: rgba(22, 27, 34, 0.92);
            transition: 0.5s;
            border-top: 1px solid rgba(255,255,255,0.08);
            position: relative;
        }

        .ticket-visual-unit:hover {
            transform: translateY(-15px) scale(1.02);
            background: rgba(35, 41, 51, 1);
            border-color: var(--gold-bright);
        }

        .badge-status-glow {
            padding: 14px 28px;
            border-radius: 18px;
            font-size: 1.05rem;
            font-weight: 950;
            display: inline-block;
            margin-bottom: 40px;
            letter-spacing: 1.5px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* --- Daily Stats Grid Matrix --- */
        .daily-matrix-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 55px;
        }

        .branch-data-card {
            padding: 75px;
            text-align: center;
            border-bottom: 15px solid var(--gold-master);
            background: rgba(255,255,255,0.04);
            border-radius: var(--radius-massive);
            transition: 0.6s;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .branch-data-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.08); }

        .massive-daily-input {
            font-size: 6.5rem;
            font-weight: 950;
            color: var(--gold-master);
            width: 100%;
            text-align: center;
            background: transparent;
            border: none;
            border-bottom: 10px solid var(--border-glow-line);
            margin-top: 45px;
            transition: 0.4s;
        }

        .massive-daily-input:focus { border-color: var(--gold-bright); color: var(--gold-bright); outline: none; }

        /* --- Audit Logs Visualization --- */
        .audit-logs-viewport {
            margin-top: 55px;
            padding: 40px;
            background: rgba(0,0,0,0.55);
            border-radius: 25px;
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid rgba(255,255,255,0.08);
        }

        .audit-row-item {
            padding: 22px 0;
            border-bottom: 1.5px solid rgba(255,255,255,0.08);
            font-size: 1.25rem;
            color: var(--text-muted-core);
            line-height: 1.6;
        }

        .audit-row-item b { color: var(--gold-master); }
        .audit-row-item .timestamp-label { display: block; font-size: 0.95rem; opacity: 0.6; margin-top: 8px; color: var(--accent-navy); font-weight: 800; }

        /* --- Form Control Mastery --- */
        label {
            display: block;
            font-size: 1.25rem;
            color: var(--text-muted-core);
            margin-bottom: 18px;
            font-weight: 900;
        }

        input, select, textarea {
            width: 100%;
            padding: 26px;
            border-radius: 22px;
            background: #010409;
            border: 2.5px solid var(--border-glow-line);
            color: white;
            margin-bottom: 35px;
            font-family: var(--font-stack);
            font-size: 1.25rem;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.2);
        }

        input:focus, select:focus { border-color: var(--gold-master); box-shadow: 0 0 25px rgba(245, 158, 11, 0.25); }

        .btn-vip-execute-master {
            background: var(--gold-master);
            color: #000;
            border: none;
            padding: 30px;
            border-radius: 25px;
            font-weight: 950;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 22px;
            font-size: 1.6rem;
            box-shadow: 0 30px 60px rgba(245, 158, 11, 0.5);
            transition: 0.4s;
        }

        .btn-vip-execute-master:hover { filter: brightness(1.3); transform: translateY(-10px); }

        /* --- Analytics Module UI --- */
        .stat-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 60px;
            margin-bottom: 100px;
        }

        .analytics-pill-card {
            padding: 60px;
            text-align: center;
            border-radius: 35px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-glow-line);
            transition: 0.5s;
        }

        .analytics-pill-card:hover { background: rgba(255,255,255,0.08); transform: scale(1.05); }

        .analytics-pill-card h2 { font-size: 4.5rem; font-weight: 950; color: var(--gold-master); }
        .analytics-pill-card p { font-size: 1.45rem; color: var(--text-muted-core); font-weight: 800; margin-top: 20px; }

        /* --- Chart Massive Viewer --- */
        .chart-viewport-massive {
            padding: 100px;
            background: rgba(0,0,0,0.45);
            border-radius: 45px;
            border: 3px solid var(--border-glow-line);
            position: relative;
        }

        .analytics-dual-layout {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 60px;
            margin-top: 60px;
        }

        /* --- Admin Matrix Hub --- */
        .admin-layout-flex {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 80px;
        }

        .scrollable-admin-list {
            max-height: 500px;
            overflow-y: auto;
            border: 3px solid var(--border-glow-line);
            border-radius: 25px;
            padding: 30px;
            background: rgba(0,0,0,0.3);
        }

        .admin-row-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            transition: 0.4s;
        }

        .admin-row-item:hover { background: rgba(255,255,255,0.05); }

        /* --- System Toast Notification --- */
        #system-toast-container {
            position: fixed;
            bottom: 50px;
            right: 50px;
            z-index: 6000;
        }

        .toast-msg-vip {
            background: var(--gold-master);
            color: #000;
            padding: 25px 50px;
            border-radius: 20px;
            font-weight: 950;
            box-shadow: 0 20px 45px rgba(0,0,0,0.7);
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            animation: slideInRight 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .hidden { display: none !important; }

        /* --- Login Portal Arc --- */
        #auth-portal-mask {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 9999;
            position: fixed;
            inset: 0;
        }

        .login-card-massive {
            width: 700px;
            padding: 120px 100px;
            text-align: center;
            border: 8px solid var(--gold-master);
        }

    </style>
</head>
<body>

    <!-- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ -->
    <div id="system-toast-container"></div>

    <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="master-dimmer" class="dimmer-overlay-master" onclick="closeSidebarControl()"></div>

    <!-- 
        ========================================================================
        --- AUTHENTICATION CORE PORTAL ---
        Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø¨Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚
        ========================================================================
    -->
    <div id="auth-portal-mask">
        <div class="massive-glass-card login-card-massive">
            <div class="identity-orb-vip" style="width:190px; height:190px; margin:0 auto 70px; font-size:7rem;">VIP</div>
            <h1 style="color:var(--gold-master); font-weight:950; font-size:4.2rem; margin-bottom:20px; letter-spacing:3px;">CENTRAL COMMAND</h1>
            <p style="color:var(--text-muted-core); margin-bottom:80px; font-weight:900; font-size:1.6rem;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„ÙØ§Ø¦Ù‚ V44.0</p>
            
            <input type="text" id="auth-uid-master" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (UID)">
            <input type="password" id="auth-pwd-master" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ù…Ø´ÙØ± (PWD)">
            
            <button class="btn-vip-execute-master" onclick="runSecurityAuthSequence()">ÙˆÙ„ÙˆØ¬ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© <i class="fas fa-shield-halved"></i></button>
        </div>
    </div>

    <!-- 
        ========================================================================
        --- MAIN MASTER INTERFACE ENGINE ---
        Ù…Ø­Ø±Ùƒ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø¹Ø¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        ========================================================================
    -->
    <div id="main-system-viewport" class="hidden">
        <div class="vip-master-container">
            
            <!-- Navbar Header Hub -->
            <nav class="massive-glass-card system-top-nav">
                <div class="identity-matrix">
                    <div class="identity-orb-vip" id="ui-avatar-orb">V</div>
                    <div class="identity-labels">
                        <h2 id="ui-user-fullname">---</h2>
                        <span id="ui-user-rank-label">---</span>
                    </div>
                </div>
                <div class="nav-hub-menu">
                    <button class="nav-link-vip active" id="tab-live" onclick="switchToAppModule('live')"><i class="fas fa-satellite-dish"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                    <button class="nav-link-vip" id="tab-daily" onclick="switchToAppModule('daily')"><i class="fas fa-calendar-check"></i> ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
                    <button class="nav-link-vip" id="tab-archive" onclick="switchToAppModule('archive')"><i class="fas fa-database"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                    <button class="nav-link-vip" id="tab-reports" onclick="switchToAppModule('reports')"><i class="fas fa-chart-line"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©</button>
                    <button class="nav-link-vip hidden" id="tab-admin" onclick="switchToAppModule('admin')"><i class="fas fa-crown"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</button>
                    <button class="nav-link-vip" onclick="runSystemLogoutSequence()" style="color:var(--danger-pulse); border-color:var(--danger-pulse)"><i class="fas fa-power-off"></i></button>
                </div>
            </nav>

            <!-- Floating Command Trigger -->
            <button class="floating-action-master" id="floating-plus-btn" onclick="openSidebarControl()"><i class="fas fa-plus"></i></button>

            <!-- 
                ========================================================================
                --- MODULE: LIVE BROADCAST (Ø¨Ø« Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±) ---
                ========================================================================
            -->
            <div id="module-view-live">
                <div id="render-live-feed-matrix" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(800px, 1fr)); gap:75px;"></div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: DAILY SNAPSHOT MATRIX (Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¬Ø¯Ø¯Ø© Ù„ÙƒÙ„ ØªØ§Ø±ÙŠØ®) ---
                ========================================================================
            -->
            <div id="module-view-daily" class="hidden">
                <div class="massive-glass-card" style="padding:120px; margin-bottom:80px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:100px;">
                        <div>
                            <h2 style="color:var(--gold-master); font-size:4.2rem; margin:0;"><i class="fas fa-calculator-combined"></i> Ù…Ø­Ø±Ùƒ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠ</h2>
                            <p style="color:var(--text-muted-core); font-size:1.6rem; margin-top:25px;">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¯ Ù„ÙØªØ­ ØµÙØ­Ø© Ø³Ø¬Ù„Ø§Øª Ù…Ù†ÙØµÙ„Ø© ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª.</p>
                        </div>
                        <div style="width:450px; text-align:left;">
                            <label>ØªØ§Ø±ÙŠØ® ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Snapshot):</label>
                            <input type="date" id="daily-master-date-picker" style="margin:0; font-size:1.6rem; font-weight:950;" onchange="loadDailySnapshotData()">
                        </div>
                    </div>
                    <!-- Ø´Ø¨ÙƒØ© Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                    <div id="render-daily-grid-hub" class="daily-matrix-display"></div>
                </div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: ARCHIVE HUB (Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ) ---
                ========================================================================
            -->
            <div id="module-view-archive" class="hidden">
                <div class="massive-glass-card" style="padding:70px; display:flex; gap:60px; margin-bottom:80px; align-items:flex-end;">
                    <div style="flex:1;"><label>Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archive-date-from" onchange="runArchiveRefreshSequence()"></div>
                    <div style="flex:1;"><label>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archive-date-to" onchange="runArchiveRefreshSequence()"></div>
                    <button class="btn-vip-execute-master" style="width:450px;" onclick="runArchiveRefreshSequence()">ØªØ­Ø¯ÙŠØ« Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© <i class="fas fa-rotate"></i></button>
                </div>
                <div id="render-archive-grid-hub" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(800px, 1fr)); gap:75px;"></div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: ANALYTICS COMMAND HUB (ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙØ§Ø¡Ø© ÙˆÙ…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£) ---
                ========================================================================
            -->
            <div id="module-view-reports" class="hidden">
                <div class="massive-glass-card" style="padding:60px; display:flex; gap:60px; margin-bottom:80px;">
                    <div style="flex:1;"><label>ÙØªØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù†:</label><input type="date" id="reports-date-from"></div>
                    <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="reports-date-to"></div>
                    <button class="btn-vip-execute-master" style="width:400px; margin-top:45px;" onclick="executeAdvancedAnalyticsSequence()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ§Ø¦Ù‚ <i class="fas fa-brain"></i></button>
                    <button class="btn-vip-execute-master" style="width:320px; margin-top:45px; background:var(--accent-navy); color:white;" onclick="exportReportsToExcel()">ØªØµØ¯ÙŠØ± Excel <i class="fas fa-file-excel"></i></button>
                </div>
                
                <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© -->
                <div id="render-analytics-stat-row" class="stat-cards-grid"></div>
                
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© -->
                <div class="analytics-dual-layout">
                    <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£) -->
                    <div class="massive-glass-card chart-viewport-massive">
                        <h3 style="color:var(--gold-master); font-size:2.8rem; margin-bottom:40px;">ğŸ“Š Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ 100 Ø£ÙˆØ±Ø¯Ø±</h3>
                        <p style="color:var(--text-muted-core); margin-bottom:30px; font-size:1.2rem;">ÙŠÙ‚Ø§Ø±Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¨Ø¯Ù‚Ø©.</p>
                        <canvas id="master-reports-canvas" style="max-height: 600px;"></canvas>
                    </div>

                    <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰) -->
                    <div class="massive-glass-card chart-viewport-massive">
                        <h3 style="color:var(--gold-master); font-size:2.8rem; margin-bottom:40px;">ğŸ“‰ ØªØ­Ù„ÙŠÙ„ ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h3>
                        <p style="color:var(--text-muted-core); margin-bottom:30px; font-size:1.2rem;">ØªÙˆØ²ÙŠØ¹ Ù†Ø³Ø¨ÙŠ Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ (Ø£ÙˆØ±Ø¯Ø± Ù†Ø§Ù‚ØµØŒ ØªØ£Ø®ÙŠØ±ØŒ Ø¥Ù„Ø®).</p>
                        <div style="height: 500px; display:flex; justify-content:center;">
                            <canvas id="master-types-canvas"></canvas>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 
                ========================================================================
                --- MODULE: ADMIN CONTROL MATRIX (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©) ---
                ========================================================================
            -->
            <div id="module-view-admin" class="hidden">
                <div class="admin-layout-flex">
                    
                    <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© -->
                    <div class="massive-glass-card" style="padding:100px;">
                        <h3 style="color:var(--gold-master); font-size:2.8rem; margin-bottom:70px;"><i class="fas fa-store-slash"></i> Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3>
                        <div style="display:flex; gap:35px; margin-bottom:55px;">
                            <input id="adm-branch-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                            <button class="btn-vip-execute-master" style="width:220px;" onclick="addSystemBranchCore()">Ø¥Ø¯Ø±Ø§Ø¬ ÙØ±Ø¹</button>
                        </div>
                        <div id="adm-branches-scroll-box" class="scrollable-admin-list" style="margin-bottom:80px;"></div>
                        
                        <hr style="border:0; border-top:4px solid var(--border-glow-line); margin:70px 0;">
                        
                        <h3 style="color:var(--gold-master); font-size:2.4rem; margin-bottom:50px;"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</h3>
                        <select id="adm-whatsapp-br-sel" onchange="renderBranchWhatsappList()"></select>
                        <div style="display:flex; gap:30px;">
                            <input id="adm-whatsapp-phone-input" placeholder="Ù…Ø«Ø§Ù„: 2010XXXXXXXX">
                            <button class="btn-vip-execute-master" style="width:220px; background:var(--success-glow); color:#000;" onclick="bindNewWhatsappToBranch()">+ Ø±Ø¨Ø· Ø±Ù‚Ù…</button>
                        </div>
                        <div id="adm-whatsapp-scroll-box" class="scrollable-admin-list" style="margin-top:45px;"></div>
                    </div>

                    <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±ØªØ¨ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ø¨Ø´Ø±ÙŠØ© -->
                    <div class="massive-glass-card" style="padding:100px;">
                        <h3 style="color:var(--gold-master); font-size:2.8rem; margin-bottom:70px;"><i class="fas fa-shield-halved"></i> Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ØªØ¨ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ§Ø¯Ø±</h3>
                        <div style="display:flex; gap:30px; margin-bottom:55px;">
                            <input id="adm-rank-name-input" placeholder="Ø§Ø³Ù… Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                            <button class="btn-vip-execute-master" style="width:220px;" onclick="registerNewRankTitleCore()">Ø¥Ø¶Ø§ÙØ© Ø±ØªØ¨Ø©</button>
                        </div>
                        <select id="adm-rank-matrix-sel" onchange="loadRankPermissionsMatrixHub()"></select>
                        <div id="adm-permissions-grid-hub" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:40px; background:rgba(0,0,0,0.6); padding:60px; border-radius:30px; margin-top:45px; border:3px solid var(--border-glow-line);">
                            <label><input type="checkbox" id="perm-view-all"> Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø©</label>
                            <label><input type="checkbox" id="perm-create-ticket"> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§ØºØ§Øª</label>
                            <label><input type="checkbox" id="perm-reply-ticket"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø¯</label>
                            <label><input type="checkbox" id="perm-daily-edit"> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                            <label><input type="checkbox" id="perm-admin-access"> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                            <button class="btn-vip-execute-master" style="grid-column: span 2; margin-top:40px;" onclick="saveRankPermissionsSequence()">ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
                        </div>

                        <hr style="border:0; border-top:4px solid var(--border-glow-line); margin:80px 0;">
                        
                        <h3 style="color:var(--gold-master); font-size:2.4rem; margin-bottom:60px;">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶Ùˆ VIP Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©</h3>
                        <input id="reg-user-id-core" placeholder="ÙƒÙˆØ¯ ID Ø§Ù„Ø¯Ø®ÙˆÙ„">
                        <input id="reg-user-fullname-core" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù">
                        <select id="reg-user-rank-sel-core"></select>
                        <select id="reg-user-branch-sel-core"></select>
                        <input id="reg-user-pass-core" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø©">
                        <button class="btn-vip-execute-master" onclick="registerNewUserToSystemSequence()">Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</button>
                        <div id="adm-users-scroll-box" class="scrollable-admin-list" style="margin-top:60px;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 
        ========================================================================
        --- SIDEBAR: COMPLAINT ENTRY ENGINE ---
        Ù…Ø­Ø±Ùƒ ØªØ­Ø±ÙŠØ± Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØªÙˆØ¬ÙŠÙ‡Ù‡Ø§ Ù„Ù„ÙØ±ÙˆØ¹
        ========================================================================
    -->
    <div id="sidebar-complaint-arc-hub" class="sidebar-complaint-master">
        <h2 style="color:var(--gold-master); font-size:3.5rem; margin-bottom:70px;"><i class="fas fa-file-signature"></i> ØªØ­Ø±ÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¨Ù„Ø§Øº VIP</h2>
        
        <label>ÙØ±Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ù†ÙŠ Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©</label>
        <select id="f-branch-master-sel"></select>
        
        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± (Order Identifier)</label>
        <input id="f-order-id-input" placeholder="#00000000">
        
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</label>
        <input id="f-customer-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        
        <label>ØªØµÙ†ÙŠÙ ÙˆØ·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„ÙÙ†ÙŠ</label>
        <select id="f-complaint-type-sel">
            <option>Ø£ÙˆØ±Ø¯Ø± Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option>
            <option>ØªØ£Ø®ÙŠØ± Ø­Ø§Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
            <option>Ø¬ÙˆØ¯Ø© Ø·Ø¹Ø§Ù… Ø³ÙŠØ¦Ø©</option>
            <option>Ø³ÙˆØ¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø·ÙŠØ§Ø±</option>
            <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        
        <label>Ø§Ø³Ù… ÙƒØ§Ø¨ØªÙ† Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ù„Ø·ÙŠØ§Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)</label>
        <input id="f-driver-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±">
        
        <label>Ù†Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© Ø¨Ø¯Ù‚Ø©</label>
        <textarea id="f-complaint-msg-input" rows="10" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø¯Ù‚Ø© Ù‡Ù†Ø§ Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§..."></textarea>
        
        <button class="btn-vip-execute-master" id="submit-complaint-btn" onclick="runComplaintTicketSequence()">ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº ÙÙˆØ±Ø§Ù‹ Ù„Ù„ÙØ±Ø¹ ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨ <i class="fab fa-whatsapp"></i></button>
    </div>

    <!-- 
        ========================================================================
        --- JAVASCRIPT MASTER CORE ENGINE V44.0 ---
        Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ - ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø¨Ø±Ù…Ø¬ÙŠ ÙƒØ«ÙŠÙ ÙˆÙ…Ø­Ø±Ùƒ ØªØ­Ù„ÙŠÙ„
        ========================================================================
    -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        /* 
           ========================================================================
           --- INTERNAL CORE LOGIC: VIP INFINITE INTELLIGENCE --- 
           Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¶Ù… Ø£ÙƒØ«Ø± Ù…Ù† 1200 Ø³Ø·Ø± Ø¨Ø±Ù…Ø¬ÙŠ Ù…ÙØµÙ„ Ù„Ø¶Ù…Ø§Ù† Ø£Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡
           ========================================================================
        */
        const firebaseConfig = {
            apiKey: "AIzaSyBSwsheoAEJm3pLMI8lhVvzFnLS-a4FrVA",
            authDomain: "break2-5de32.firebaseapp.com",
            databaseURL: "https://break2-5de32-default-rtdb.firebaseio.com",
            projectId: "break2-5de32",
            storageBucket: "break2-5de32.firebasestorage.app",
            messagingSenderId: "864134684796",
            appId: "1:864134684796:web:078af20f713c95a08be9f9"
        };
        firebase.initializeApp(firebaseConfig);
        const dbHub = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global System State)
        let currentUserSession = null;
        let complaintsCache = {};
        let systemSettingsCache = {};
        let branchListCache = [];
        let analyticsChartInstance = null;
        let analyticsTypeChartInstance = null; // Ù…ØªØºÙŠØ± Ù„Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ (Security Auth Module)
         * ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆÙ„ÙˆØ¬
         */
        async function runSecurityAuthSequence() {
            const uid = document.getElementById('auth-uid-master').value.trim();
            const pwd = document.getElementById('auth-pwd-master').value.trim();

            if(!uid || !pwd) {
                renderSystemToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ„ÙˆØ¬ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©!", "danger");
                return;
            }

            // Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„ÙˆØ¬ Ø§Ù„ÙØ§Ø¦Ù‚ Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ù…Ù„Ø§Ùƒ
            if(uid === 'super' && pwd === 'vip2026') {
                grantCoreAccess({id:'super', name:'Super Administrator', title:'ROOT-COMMAND', branch:'ALL', role:'SUPER'});
                return;
            }

            const snap = await dbHub.ref('users/' + uid).get();
            if(snap.exists() && snap.val().pass === pwd) {
                grantCoreAccess({id: uid, ...snap.val()});
            } else {
                Swal.fire('Ø§Ø®ØªØ±Ø§Ù‚ Ø£Ù…Ù†ÙŠ Ø£Ùˆ Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø³Ø¬Ù„Ø§ØªÙ†Ø§.', 'error');
            }
        }

        function grantCoreAccess(data) {
            localStorage.setItem('vip_v43_secure_token', JSON.stringify(data));
            location.reload();
        }

        function runSystemLogoutSequence() {
            localStorage.removeItem('vip_v43_secure_token');
            location.reload();
        }

        /**
         * ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
         */
        window.onload = () => {
            const sess = localStorage.getItem('vip_v43_secure_token');
            if(sess) {
                currentUserSession = JSON.parse(sess);
                document.getElementById('auth-portal-mask').classList.add('hidden');
                document.getElementById('main-system-viewport').classList.remove('hidden');
                document.getElementById('ui-user-fullname').innerText = currentUserSession.name;
                document.getElementById('ui-user-rank-label').innerText = currentUserSession.title;
                document.getElementById('ui-avatar-orb').innerText = currentUserSession.name.charAt(0);
                
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('daily-master-date-picker').value = todayStr;
                document.getElementById('archive-date-from').value = todayStr;
                document.getElementById('archive-date-to').value = todayStr;
                document.getElementById('reports-date-from').value = todayStr;
                document.getElementById('reports-date-to').value = todayStr;

                initCoreDataListeners();
            }
        };

        /**
         * Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Real-time Stream Engine)
         */
        function initCoreDataListeners() {
            // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙØ±ÙˆØ¹ØŒ Ø±ØªØ¨ØŒ Ù‡ÙˆØ§ØªÙ)
            dbHub.ref('settings').on('value', snap => {
                systemSettingsCache = snap.val() || {};
                branchListCache = systemSettingsCache.branches ? Object.values(systemSettingsCache.branches) : [];
                syncUiDropdownSelections();
                renderAdminBranchScrollBox();
                renderAdminUsersScrollBox();
                renderBranchWhatsappList();
                loadDailySnapshotData(); 
                runPermissionShieldCheck();
            });

            // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)
            dbHub.ref('operations').on('value', snap => {
                complaintsCache = snap.val() || {};
                renderLiveBroadcastMatrix(); 
                runArchiveRefreshSequence();
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (DYNAMIC DAILY SNAPSHOT)
         * ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø³Ø¬Ù„Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„ÙƒÙ„ ØªØ§Ø±ÙŠØ®
         */
        async function loadDailySnapshotData() {
            const dateStr = document.getElementById('daily-master-date-picker').value;
            const gridBox = document.getElementById('render-daily-grid-hub');
            gridBox.innerHTML = `<h2 style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 120px;">Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù…ØµÙÙˆÙØ© Ø³Ø¬Ù„Ø§Øª ÙŠÙˆÙ… ${dateStr}...</h2>`;

            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canEdit = p.daily_edit || currentUserSession.role === 'SUPER';
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            const dSnap = await dbHub.ref(`daily_stats/${dateStr}`).get();
            const dailyData = dSnap.val() || {};
            
            gridBox.innerHTML = "";
            branchListCache.forEach(branch => {
                if(!canSeeAll && branch !== currentUserSession.branch) return;

                gridBox.innerHTML += `
                    <div class="massive-glass-card branch-data-card">
                        <h4 style="font-size: 2.8rem; margin: 0;">${branch}</h4>
                        <input type="number" class="massive-daily-input" 
                               value="${dailyData[branch] || 0}" 
                               ${canEdit ? '' : 'disabled'} 
                               onchange="commitDailyOrderValue('${dateStr}', '${branch}', this.value)">
                        <div style="font-size: 1.6rem; color: var(--text-muted-core); margin-top: 40px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª ÙŠÙˆÙ… ${dateStr}</div>
                    </div>`;
            });
        }

        async function commitDailyOrderValue(date, br, val) {
            if(val < 0) { renderSystemToast("Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ù„Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©!", "danger"); return; }
            await dbHub.ref(`daily_stats/${date}/${br}`).set(val);
            renderSystemToast(`ØªÙ… Ø­ÙØ¸ Ø£ÙˆØ±Ø¯Ø±Ø§Øª ${br} Ù„ÙŠÙˆÙ… ${date}`, "success");
        }

        /**
         * Ù…Ø­Ø±Ùƒ ØªØ­Ø±ÙŠØ± ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Complaint Entry Core)
         */
        async function runComplaintTicketSequence() {
            const br = document.getElementById('f-branch-master-sel').value;
            const ord = document.getElementById('f-order-id-input').value.trim();
            const cust = document.getElementById('f-customer-name-input').value.trim();
            const type = document.getElementById('f-complaint-type-sel').value;
            const drv = document.getElementById('f-driver-name-input').value.trim();
            const msg = document.getElementById('f-complaint-msg-input').value.trim();

            if(!ord || !cust || !msg) {
                Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡.', 'warning');
                return;
            }

            const timeNow = new Date().toLocaleTimeString('ar-EG');
            const dateNow = new Date().toISOString().split('T')[0];

            const ticketData = {
                branch: br, order: ord, customer: cust, type: type, 
                msg: msg, driver: drv,
                stage: 'waiting_review', status: 'active',
                timestamp: new Date().toLocaleString('ar-EG'), timeOnly: timeNow, date: dateNow,
                author: currentUserSession.name,
                logs: [{ time: timeNow, user: currentUserSession.name, action: "ØªØ­Ø±ÙŠØ± Ø¨Ù„Ø§Øº VIP ÙˆØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©." }]
            };

            await dbHub.ref('operations').push(ticketData);
            triggerBranchBroadcast(br, ord, cust, type, msg, timeNow);
            closeSidebarControl();
            renderSystemToast("ØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            
            ['f-order-id-input','f-customer-name-input','f-complaint-msg-input','f-driver-name-input'].forEach(id => document.getElementById(id).value = '');
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¨Ø« Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Multi-Channel Broadcast)
         */
        async function triggerBranchBroadcast(br, ord, cust, type, msg, time) {
            const pMap = systemSettingsCache.phones ? (systemSettingsCache.phones[br] || {}) : {};
            const pList = Object.values(pMap);
            if(pList.length === 0) return;

            const text = `ğŸš¨ *Ø¨Ù„Ø§Øº VIP Ø¬Ø¯ÙŠØ¯* ğŸš¨\n\nğŸ“ Ø§Ù„ÙØ±Ø¹: ${br}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${time}\nğŸ”¢ Ø§Ù„Ø·Ù„Ø¨: ${ord}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${cust}\nğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹: ${type}\nğŸ“ Ø§Ù„Ø´ÙƒÙˆÙ‰: ${msg}\nğŸ‘· Ø§Ù„Ù…ØªÙ„Ù‚ÙŠ Ø¨Ø§Ù„ÙØ±Ø¹: ${currentUserSession.name}`;
            
            pList.forEach(ph => {
                fetch(`https://api.ultramsg.com/instance157671/messages/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({'token': 'cpx85mx613v868fe', 'to': ph, 'body': text})
                });
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Live Matrix Renderer)
         */
        function renderLiveBroadcastMatrix() {
            const box = document.getElementById('render-live-feed-matrix');
            box.innerHTML = "";
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            Object.keys(complaintsCache).reverse().forEach(id => {
                const op = complaintsCache[id];
                if(op.status === 'done') return; 
                if(!canSeeAll && op.branch !== currentUserSession.branch) return;

                box.innerHTML += generateTicketMarkup(id, op, true, p);
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ (History Hub Renderer)
         */
        function runArchiveRefreshSequence() {
            const box = document.getElementById('render-archive-grid-hub');
            if(!box) return;
            box.innerHTML = "";
            const from = document.getElementById('archive-date-from').value;
            const to = document.getElementById('archive-date-to').value;
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            Object.keys(complaintsCache).reverse().forEach(id => {
                const op = complaintsCache[id];
                if(op.status !== 'done') return;
                if(!canSeeAll && op.branch !== currentUserSession.branch) return;
                if(op.date < from || op.date > to) return;

                box.innerHTML += generateTicketMarkup(id, op, false, p);
            });
        }

        /**
         * Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨ØµØ±ÙŠ (Visual Card Builder)
         */
        function generateTicketMarkup(id, op, isInteractive, p) {
            let btns = "";
            if(isInteractive) {
                if(op.stage === 'waiting_review' && (p.reply_ticket || currentUserSession.role === 'SUPER')) {
                    btns = `<button class="btn-vip-execute-master" style="background:var(--success-glow); color:#000;" onclick="openBranchReplyModalHub('${id}')">Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© <i class="fas fa-reply-all"></i></button>`;
                } else if(op.stage === 'replied' && (currentUserSession.title === 'Ø¯ÙŠØ³Ø¨ØªØ´Ø±' || currentUserSession.role === 'SUPER')) {
                    btns = `<button class="btn-vip-execute-master" onclick="finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø±Ø´ÙŠÙ</button>`;
                }
            }

            const logs = op.logs ? op.logs.map(l => `
                <div class="audit-row-item">
                    <b>${l.user}:</b> ${l.action}
                    <span class="timestamp-label">${l.time}</span>
                </div>`).join('') : '';

            const badge = op.branch_verdict === 'Ù†Ø§Ù‚Øµ' ? 
                '<span class="badge-status-glow" style="background:rgba(239, 68, 68, 0.2); color:var(--danger-pulse); border:3px solid var(--danger-pulse);">ØªØ£ÙƒÙŠØ¯ Ù†Ù‚Øµ ÙØ¹Ù„ÙŠ âŒ</span>' : 
                (op.branch_verdict === 'ÙƒØ§Ù…Ù„' ? '<span class="badge-status-glow" style="background:rgba(16, 185, 129, 0.2); color:var(--success-glow); border:3px solid var(--success-glow);">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙƒØ§Ù…Ù„ ÙˆØ³Ù„ÙŠÙ… âœ…</span>' : '');

            return `
                <div class="massive-glass-card ticket-visual-unit">
                    <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
                        <b style="color:var(--gold-master); font-size:2.5rem;">ğŸ“ ÙØ±Ø¹ : ${op.branch}</b>
                        <span style="opacity:0.7; font-weight:900;">${op.timestamp}</span>
                    </div>
                    ${badge}
                    <div style="font-size:3.5rem; font-weight:950; margin-bottom:35px;">ğŸ“¦ Ø£ÙˆØ±Ø¯Ø±: #${op.order}</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:35px; margin-bottom:35px; color:var(--accent-navy); font-weight:950; font-size:1.8rem;">
                        <span>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${op.customer}</span>
                        <span>ğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹: ${op.type}</span>
                    </div>
                    <div style="color:var(--success-glow); font-weight:950; margin-bottom:35px; font-size:1.8rem;">ğŸ‘¨â€âœˆï¸ Ø§Ù„Ø·ÙŠØ§Ø±: ${op.driver || '---'}</div>
                    <p style="background:rgba(0,0,0,0.65); padding:50px; border-radius:30px; border:2px solid rgba(255,255,255,0.1); font-size:1.8rem; line-height:1.8;">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰: ${op.msg}</p>
                    <div class="audit-logs-viewport">${logs}</div>
                    <div style="margin-top:55px;">${btns}</div>
                </div>`;
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ù…Ø·ÙˆØ± (ULTRA ANALYTICS ENGINE)
         * ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙØ±Ø¯ÙŠØ© Ù„ÙƒÙ„ ÙØ±Ø¹ + ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰
         */
        async function executeAdvancedAnalyticsSequence() {
            const from = document.getElementById('reports-date-from').value;
            const to = document.getElementById('reports-date-to').value;
            // ØªØµÙÙŠØ© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const ops = Object.values(complaintsCache).filter(o => o.date >= from && o.date <= to);
            
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            const resolved = ops.filter(o => o.status === 'done').length;
            document.getElementById('render-analytics-stat-row').innerHTML = `
                <div class="analytics-pill-card" style="border-top: 12px solid var(--gold-master)"><h2>${ops.length}</h2><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--success-glow)"><h2>${resolved}</h2><p>Ø¨Ù„Ø§ØºØ§Øª Ù…ØºÙ„Ù‚Ø©</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--danger-pulse)"><h2>${ops.length - resolved}</h2><p>Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--accent-navy)"><h2>${ops.length ? Math.round((resolved/ops.length)*100) : 0}%</h2><p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p></div>
            `;

            // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø£ÙˆÙ„ (Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ ÙØ±Ø¹)
            const dSnap = await dbHub.ref('daily_stats').get();
            const allDays = dSnap.val() || {};

            const labels = [];
            const complaintsCounts = [];
            const ordersCounts = [];
            const ratios = [];

            branchListCache.forEach(br => {
                if(!canSeeAll && br !== currentUserSession.branch) return;
                labels.push(br);

                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„Ù„ÙØ±Ø¹
                const brComplaints = ops.filter(o => o.branch === br).length;
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙØ±Ø¹ ÙÙŠ Ø§Ù„ÙØªØ±Ø©
                let brOrders = 0;
                Object.keys(allDays).forEach(day => {
                    if(day >= from && day <= to && allDays[day][br]) {
                        brOrders += parseInt(allDays[day][br]);
                    }
                });

                complaintsCounts.push(brComplaints);
                ordersCounts.push(brOrders);
                ratios.push(brOrders > 0 ? ((brComplaints / brOrders) * 100).toFixed(2) : 0);
            });

            // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Bar Chart)
            if(analyticsChartInstance) analyticsChartInstance.destroy();
            analyticsChartInstance = new Chart(document.getElementById('master-reports-canvas'), {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ % (Ù†Ø³Ø¨Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª)', 
                        data: ratios, 
                        backgroundColor: '#f59e0b', 
                        borderRadius: 20,
                        // Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ø±Ø¶
                        customComplaints: complaintsCounts,
                        customOrders: ordersCounts
                    }] 
                },
                options: { 
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: '#fff', font: {size: 14} } }, 
                        x: { ticks: { color: '#fff', font: {size: 14} } } 
                    },
                    plugins: { 
                        legend: { labels: { color: '#fff', font: {size: 16, weight: 'bold'} } },
                        datalabels: { 
                            anchor: 'end',
                            align: 'top',
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, context) => {
                                const c = context.dataset.customComplaints[context.dataIndex];
                                const o = context.dataset.customOrders[context.dataIndex];
                                return `Ø´ÙƒÙˆÙ‰: ${c} | Ø£ÙˆØ±Ø¯Ø±: ${o}\n(${value}%)`;
                            },
                            textAlign: 'center'
                        }
                    }
                }
            });

            // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ (ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ - Pie/Doughnut)
            const typeCounts = {};
            let filteredOpsForType = ops;
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ±Ù‰ Ø§Ù„ÙƒÙ„ØŒ Ù†ØµÙÙŠ ÙÙ‚Ø· Ø´ÙƒØ§ÙˆÙ‰ ÙØ±Ø¹Ù‡
            if (!canSeeAll) {
                filteredOpsForType = ops.filter(o => o.branch === currentUserSession.branch);
            }

            filteredOpsForType.forEach(o => {
                const t = o.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                typeCounts[t] = (typeCounts[t] || 0) + 1;
            });

            const typeLabels = Object.keys(typeCounts);
            const typeValues = Object.values(typeCounts);
            const totalComplaints = typeValues.reduce((a, b) => a + b, 0);

            // Ø£Ù„ÙˆØ§Ù† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
            const pieColors = [
                '#f59e0b', '#ef4444', '#10b981', '#1d4ed8', '#8b5cf6', '#ec4899', '#6366f1'
            ];

            // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ (Doughnut Chart)
            if(analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();
            analyticsTypeChartInstance = new Chart(document.getElementById('master-types-canvas'), {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeValues,
                        backgroundColor: pieColors,
                        borderColor: '#000',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', font: { size: 14 }, padding: 20 }
                        },
                        datalabels: {
                            color: '#000',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                                let percentage = ((value / totalComplaints) * 100).toFixed(1) + "%";
                                return percentage;
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            borderRadius: 6,
                            padding: 6
                        }
                    }
                }
            });
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥ÙƒØ³Ù„ (Excel Exporter)
         */
        function exportReportsToExcel() {
            const from = document.getElementById('reports-date-from').value;
            const to = document.getElementById('reports-date-to').value;
            const ops = Object.values(complaintsCache).filter(o => o.date >= from && o.date <= to);
            
            const list = ops.map(o => ({
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº': o.date,
                'ÙˆÙ‚Øª Ø§Ù„Ø¨Ù„Ø§Øº': o.timeOnly,
                'Ø§Ù„ÙØ±Ø¹': o.branch,
                'Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±': o.order,
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': o.customer,
                'Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰': o.type,
                'Ø§Ù„Ø­Ø§Ù„Ø©': o.status === 'done' ? 'Ù…ØºÙ„Ù‚' : 'Ù†Ø´Ø·',
                'Ø§Ù„Ù†ØªÙŠØ¬Ø©': o.branch_verdict || '---',
                'Ø§Ù„Ù…Ø­Ø±Ø±': o.author
            }));

            const ws = XLSX.utils.json_to_sheet(list);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "VIP_Report");
            XLSX.writeFile(wb, `VIP_Analytics_${from}_to_${to}.xlsx`);
        }

        /**
         * Ø±Ø¯ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ (Official Reply Module)
         */
        async function openBranchReplyModalHub(id) {
            const { value: res } = await Swal.fire({
                title: 'Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„ÙØ±Ø¹',
                html: `<select id="sw-status" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ø§Ù„Ø·Ù„Ø¨ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹ (Ø§Ø¹ØªØ±Ø§Ù Ø¨Ø§Ù„Ø®Ø·Ø£)</option></select>
                       <textarea id="sw-msg" class="swal2-input" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙ…Ø§ ØªÙ… Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>`,
                preConfirm: () => [document.getElementById('sw-status').value, document.getElementById('sw-msg').value]
            });

            if(res) {
                const op = complaintsCache[id];
                const action = res[0] === 'Ù†Ø§Ù‚Øµ' ? `Ø§Ù„ÙØ±Ø¹ ÙŠØ¤ÙƒØ¯: [Ù†Ù‚Øµ ÙØ¹Ù„ÙŠ âš ï¸] - ${res[1]}` : `Ø±Ø¯ Ø§Ù„ÙØ±Ø¹: [Ø§Ù„Ø·Ù„Ø¨ Ø³Ù„ÙŠÙ…] - ${res[1]}`;
                const log = { time: new Date().toLocaleTimeString('ar-EG'), user: currentUserSession.name, action: action };
                
                await dbHub.ref('operations/'+id).update({ 
                    stage: 'replied', 
                    branch_verdict: res[0], 
                    logs: [...(op.logs || []), log] 
                });
                renderSystemToast("ØªÙ… ØªØ«Ø¨ÙŠØª Ø±Ø¯ Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            }
        }

        async function finalizeTicketAndArchive(id) {
            const op = complaintsCache[id];
            const log = { time: new Date().toLocaleTimeString('ar-EG'), user: currentUserSession.name, action: "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ." };
            await dbHub.ref('operations/'+id).update({ status: 'done', logs: [...(op.logs || []), log] });
            renderSystemToast("ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }

        /**
         * Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª (UI Sync Hub)
         */
        function syncUiDropdownSelections() {
            const html = branchListCache.map(b => `<option>${b}</option>`).join('');
            document.getElementById('f-branch-master-sel').innerHTML = html;
            document.getElementById('adm-whatsapp-br-sel').innerHTML = html;
            document.getElementById('reg-user-branch-sel-core').innerHTML = `<option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>` + html;
            
            const ranks = systemSettingsCache.custom_ranks ? Object.keys(systemSettingsCache.custom_ranks) : ['Ø¯ÙŠØ³Ø¨ØªØ´Ø±', 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹'];
            const rHtml = ranks.map(r => `<option>${r}</option>`).join('');
            document.getElementById('adm-rank-matrix-sel').innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ø±ØªØ¨Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØµÙÙˆÙØªÙ‡Ø§ --</option>` + rHtml;
            document.getElementById('reg-user-rank-sel-core').innerHTML = rHtml;
        }

        function renderAdminBranchScrollBox() {
            const box = document.getElementById('adm-branches-scroll-box'); box.innerHTML = "";
            const brs = systemSettingsCache.branches || {};
            Object.keys(brs).forEach(k => {
                box.innerHTML += `
                    <div class="admin-row-item">
                        <span><i class="fas fa-building" style="color:var(--gold-master)"></i> ${brs[k]}</span>
                        <i class="fas fa-trash-alt" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('settings/branches/${k}').remove()"></i>
                    </div>`;
            });
        }

        async function addSystemBranchCore() {
            const n = document.getElementById('adm-branch-name-input').value.trim();
            if(n) await dbHub.ref('settings/branches').push(n);
            document.getElementById('adm-branch-name-input').value = "";
        }

        function renderBranchWhatsappList() {
            const br = document.getElementById('adm-whatsapp-br-sel').value;
            const box = document.getElementById('adm-whatsapp-scroll-box'); box.innerHTML = "";
            const p = systemSettingsCache.phones ? (systemSettingsCache.phones[br] || {}) : {};
            Object.keys(p).forEach(k => box.innerHTML += `
                <div class="admin-row-item">
                    <span>${p[k]}</span>
                    <i class="fas fa-trash" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('settings/phones/${br}/${k}').remove()"></i>
                </div>`);
        }

        async function bindNewWhatsappToBranch() {
            const br = document.getElementById('adm-whatsapp-br-sel').value;
            const ph = document.getElementById('adm-whatsapp-phone-input').value.trim();
            if(ph) await dbHub.ref(`settings/phones/${br}`).push(ph);
            document.getElementById('adm-whatsapp-phone-input').value = "";
        }

        function loadRankPermissionsMatrixHub() {
            const r = document.getElementById('adm-rank-matrix-sel').value;
            if(!r) { document.getElementById('adm-permissions-grid-hub').classList.add('hidden'); return; }
            document.getElementById('adm-permissions-grid-hub').classList.remove('hidden');
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[r] || {}) : {};
            document.getElementById('perm-view-all').checked = p.view_all || false;
            document.getElementById('perm-create-ticket').checked = p.create_ticket || false;
            document.getElementById('perm-reply-ticket').checked = p.reply_ticket || false;
            document.getElementById('perm-daily-edit').checked = p.daily_edit || false;
            document.getElementById('perm-admin-access').checked = p.admin_access || false;
        }

        async function saveRankPermissionsSequence() {
            const r = document.getElementById('adm-rank-matrix-sel').value;
            const data = {
                view_all: document.getElementById('perm-view-all').checked,
                create_ticket: document.getElementById('perm-create-ticket').checked,
                reply_ticket: document.getElementById('perm-reply-ticket').checked,
                daily_edit: document.getElementById('perm-daily-edit').checked,
                admin_access: document.getElementById('perm-admin-access').checked
            };
            await dbHub.ref('settings/permissions/'+r).set(data);
            renderSystemToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.", "success");
        }

        function renderAdminUsersScrollBox() {
            const box = document.getElementById('adm-users-scroll-box'); box.innerHTML = "";
            dbHub.ref('users').once('value', snap => {
                const u = snap.val() || {};
                Object.keys(u).forEach(uid => {
                    const user = u[uid];
                    box.innerHTML += `
                        <div class="admin-row-item">
                            <div>
                                <b style="color:var(--gold-master)">${user.name}</b> <small>(${user.title})</small>
                                <div style="font-size: 0.8rem; color: var(--text-muted-core)">ID: ${uid} | Ø§Ù„ÙØ±Ø¹: ${user.branch}</div>
                            </div>
                            <i class="fas fa-user-minus" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('users/${uid}').remove().then(()=>renderAdminUsersScrollBox())"></i>
                        </div>`;
                });
            });
        }

        async function registerNewUserToSystemSequence() {
            const id = document.getElementById('reg-user-id-core').value.trim();
            const data = {
                name: document.getElementById('reg-user-fullname-core').value,
                title: document.getElementById('reg-user-rank-sel-core').value,
                branch: document.getElementById('reg-user-branch-sel-core').value,
                pass: document.getElementById('reg-user-pass-core').value
            };
            if(id && data.name) await dbHub.ref('users/'+id).set(data).then(()=>renderAdminUsersScrollBox());
            renderSystemToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù.", "success");
        }

        function registerNewRankTitleCore() {
            const t = document.getElementById('adm-rank-name-input').value.trim();
            if(t) dbHub.ref('settings/custom_ranks/'+t).set(true);
            document.getElementById('adm-rank-name-input').value = "";
        }

        /**
         * ÙØ­Øµ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Permission Shield Hub)
         */
        function runPermissionShieldCheck() {
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            if(p.admin_access || currentUserSession.role === 'SUPER') document.getElementById('tab-admin').classList.remove('hidden');
            const canAdd = p.create_ticket || currentUserSession.role === 'SUPER';
            document.getElementById('floating-plus-btn').className = canAdd ? 'floating-action-master' : 'hidden';
        }

        /**
         * Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI Logic Helpers)
         */
        function openSidebarControl() {
            const sb = document.getElementById('sidebar-complaint-arc-hub');
            sb.classList.add('open');
            document.getElementById('master-dimmer').style.display = 'block';
        }

        function closeSidebarControl() {
            const sb = document.getElementById('sidebar-complaint-arc-hub');
            sb.classList.remove('open');
            document.getElementById('master-dimmer').style.display = 'none';
        }

        function switchToAppModule(m) {
            document.querySelectorAll('.nav-link-vip').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + m).classList.add('active');
            
            ['live', 'daily', 'archive', 'reports', 'admin'].forEach(id => {
                document.getElementById('module-view-' + id).classList.add('hidden');
            });
            document.getElementById('module-view-' + m).classList.remove('hidden');

            if(m === 'reports') executeAdvancedAnalyticsSequence();
            if(m === 'daily') loadDailySnapshotData();
        }

        function renderSystemToast(m, type) {
            const box = document.getElementById('system-toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-msg-vip';
            if(type === 'danger') toast.style.background = '#ef4444';
            toast.innerHTML = `<i class="fas ${type === 'danger' ? 'fa-triangle-exclamation' : 'fa-circle-check'}"></i> ${m}`;
            box.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

    </script>
</body>
</html>
