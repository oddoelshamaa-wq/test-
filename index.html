<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP SYSTEM V45.0 | SIDE-MATRIX ARCHITECTURE</title>
    
    <!-- 
        ========================================================================
        --- GLOBAL EXTERNAL INFRASTRUCTURE ---
        ========================================================================
    -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* 
           ========================================================================
           --- CSS MASTER ARCHITECTURE: VIP SIDEBAR EDITION --- 
           ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù„ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆÙŠØ©
           ========================================================================
        */
        :root {
            --primary-bg-core: #010409;
            --glass-surface: rgba(13, 17, 23, 0.96);
            --gold-master: #f59e0b;
            --gold-bright: #fbbf24;
            --accent-navy: #1d4ed8;
            --success-glow: #10b981;
            --danger-pulse: #ef4444;
            --text-pure: #f0f6fc;
            --text-muted-core: #8b949e;
            --border-glow-line: rgba(245, 158, 11, 0.28);
            --radius-massive: 28px;
            --shadow-depth: 0 40px 80px rgba(0,0,0,0.85), inset 0 1px 2px rgba(255,255,255,0.06);
            --font-stack: 'Cairo', sans-serif;
            --transition-speed: 0.35s;
            --sidebar-width: 340px; /* Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        }

        /* --- Global Smooth Animation --- */
        @keyframes slideRightFade { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotateBrand { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--primary-bg-core); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--gold-master), #d97706); border-radius: 12px; border: 3px solid var(--primary-bg-core); }

        * {
            box-sizing: border-box;
            outline: none;
            margin: 0;
            padding: 0;
            transition: var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: var(--font-stack);
            background: var(--primary-bg-core);
            color: var(--text-pure);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 15px;
            background-image: 
                radial-gradient(circle at 5% 5%, rgba(245, 158, 11, 0.08) 0%, transparent 45%),
                radial-gradient(circle at 95% 95%, rgba(29, 78, 216, 0.08) 0%, transparent 50%);
            background-attachment: fixed;
        }

        /* --- NEW LAYOUT STRUCTURE (Sidebar + Content) --- */
        
        /* 1. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ© */
        .system-side-nav {
            position: fixed;
            top: 30px;
            right: 30px;
            bottom: 30px;
            width: var(--sidebar-width);
            background: var(--glass-surface);
            backdrop-filter: blur(55px);
            border: 1px solid var(--border-glow-line);
            border-radius: var(--radius-massive);
            box-shadow: var(--shadow-depth);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 40px 30px;
            overflow-y: auto;
            animation: slideRightFade 0.8s ease-out;
        }

        /* 2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø²Ø§Ø­Ø© Ù„Ù„ÙŠØ³Ø§Ø±) */
        .vip-master-container {
            margin-right: calc(var(--sidebar-width) + 60px); /* ØªØ±Ùƒ Ù…Ø³Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
            margin-left: 30px;
            padding-top: 50px;
            padding-bottom: 100px;
            max-width: 100%;
            animation: slideUpFade 0.7s ease-out;
        }

        /* --- Sidebar Elements --- */
        .identity-matrix {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.05);
        }

        .identity-orb-vip {
            width: 110px;
            height: 110px;
            background: linear-gradient(135deg, var(--gold-master), #b45309);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 950;
            color: #000;
            font-size: 3rem;
            border: 6px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4);
            cursor: pointer;
            margin-bottom: 20px;
        }
        .identity-orb-vip:hover { animation: rotateBrand 2s infinite linear; }

        .identity-labels h2 { font-size: 1.6rem; letter-spacing: 0.8px; font-weight: 900; line-height: 1.2; }
        .identity-labels p { color: var(--gold-master); font-weight: 800; font-size: 0.95rem; margin-top: 8px; opacity: 0.9; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªÙƒÙˆÙ† Ø¹Ù…ÙˆØ¯ÙŠØ© */
        .nav-hub-menu { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            flex: 1; /* ØªØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
        }
        
        .nav-link-vip {
            background: rgba(255,255,255,0.03);
            border: 1px solid transparent;
            color: var(--text-muted-core);
            padding: 20px 25px;
            border-radius: 18px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 18px;
            transition: 0.3s;
            width: 100%;
        }

        .nav-link-vip:hover, .nav-link-vip.active {
            background: rgba(245, 158, 11, 0.15);
            color: var(--gold-master);
            border-color: var(--border-glow-line);
            transform: translateX(-8px); /* Ø­Ø±ÙƒØ© Ù„Ù„ÙŠØ³Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
            box-shadow: none;
        }
        
        .nav-link-vip.active {
            background: var(--gold-master);
            color: #000;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        .logout-btn-sidebar {
            margin-top: auto; /* Ø¯ÙØ¹ Ù„Ù„Ø£Ø³ÙÙ„ */
            background: rgba(239, 68, 68, 0.1) !important;
            color: var(--danger-pulse) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
            justify-content: center;
        }
        .logout-btn-sidebar:hover {
            background: var(--danger-pulse) !important;
            color: #fff !important;
            transform: translateY(-5px);
        }

        /* --- Cards & UI Elements --- */
        .massive-glass-card {
            background: var(--glass-surface);
            backdrop-filter: blur(55px);
            border: 1px solid var(--border-glow-line);
            border-radius: var(--radius-massive);
            box-shadow: var(--shadow-depth);
            position: relative;
            overflow: hidden;
        }

        /* --- Floating Command Center (Adjusted for Sidebar Layout) --- */
        .floating-action-master {
            position: fixed;
            bottom: 50px;
            left: 50px; /* Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gold-master);
            color: #000;
            font-size: 3.5rem;
            border: none;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 40px 90px rgba(245, 158, 11, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .floating-action-master:hover { transform: scale(1.1) rotate(90deg); }

        /* --- Sidebar Panel Core (For New Complaint) --- */
        .sidebar-complaint-master {
            position: fixed;
            top: 0;
            left: -700px; /* ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù„ÙŠÙØªØ­ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø¯Ù… ØªØºØ·ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ */
            right: auto;
            width: 600px;
            height: 100%;
            background: #0b0e14;
            border-right: 12px solid var(--gold-master); /* Ø§Ù„Ø¨ÙˆØ±Ø¯Ø± ÙŠÙ…ÙŠÙ† */
            border-left: none;
            z-index: 2600;
            padding: 70px;
            transition: 1s cubic-bezier(0.7, 0, 0.1, 1);
            box-shadow: 60px 0 200px rgba(0,0,0,1);
            overflow-y: auto;
        }
        .sidebar-complaint-master.open { left: 0; }

        .dimmer-overlay-master {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 2599;
            display: none;
        }

        /* --- Ticket Presentation UI --- */
        .ticket-visual-unit {
            padding: 50px;
            border-radius: var(--radius-massive);
            border-right: 15px solid var(--gold-master);
            margin-bottom: 40px;
            background: rgba(22, 27, 34, 0.92);
            transition: 0.5s;
            border-top: 1px solid rgba(255,255,255,0.08);
            position: relative;
        }
        .ticket-visual-unit:hover { transform: translateY(-10px) scale(1.01); border-color: var(--gold-bright); }
        .badge-status-glow { padding: 10px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 950; display: inline-block; margin-bottom: 30px; letter-spacing: 1px; }

        /* --- Daily Stats Grid Matrix --- */
        .daily-matrix-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 40px; }
        .branch-data-card { padding: 50px; text-align: center; border-bottom: 10px solid var(--gold-master); background: rgba(255,255,255,0.04); border-radius: var(--radius-massive); transition: 0.6s; border: 1px solid rgba(255,255,255,0.05); }
        .massive-daily-input { font-size: 5rem; font-weight: 950; color: var(--gold-master); width: 100%; text-align: center; background: transparent; border: none; border-bottom: 6px solid var(--border-glow-line); margin-top: 30px; transition: 0.4s; }

        /* --- Audit Logs --- */
        .audit-logs-viewport { margin-top: 40px; padding: 30px; background: rgba(0,0,0,0.55); border-radius: 20px; max-height: 300px; overflow-y: auto; border: 2px solid rgba(255,255,255,0.08); }
        .audit-row-item { padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 1.1rem; color: var(--text-muted-core); line-height: 1.6; }

        /* --- Form Control --- */
        label { display: block; font-size: 1.1rem; color: var(--text-muted-core); margin-bottom: 12px; font-weight: 900; }
        input, select, textarea { width: 100%; padding: 20px; border-radius: 18px; background: #010409; border: 2px solid var(--border-glow-line); color: white; margin-bottom: 25px; font-family: var(--font-stack); font-size: 1.1rem; }
        input:focus, select:focus { border-color: var(--gold-master); }
        .btn-vip-execute-master { background: var(--gold-master); color: #000; border: none; padding: 25px; border-radius: 20px; font-weight: 950; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.4rem; box-shadow: 0 20px 50px rgba(245, 158, 11, 0.4); transition: 0.4s; }
        .btn-vip-execute-master:hover { filter: brightness(1.2); transform: translateY(-5px); }

        /* --- Analytics Module UI --- */
        .stat-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 80px; }
        .analytics-pill-card { padding: 50px; text-align: center; border-radius: 30px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glow-line); transition: 0.5s; }
        .analytics-pill-card h2 { font-size: 3.5rem; font-weight: 950; color: var(--gold-master); }
        
        .chart-viewport-massive { padding: 60px; background: rgba(0,0,0,0.45); border-radius: 40px; border: 2px solid var(--border-glow-line); position: relative; }
        .analytics-dual-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; margin-top: 50px; }

        /* --- Admin Matrix --- */
        .admin-layout-flex { display: grid; grid-template-columns: 1fr; gap: 60px; } /* Single column in admin for better space in sidebar layout or keep as is */
        @media(min-width: 1600px) { .admin-layout-flex { grid-template-columns: 1.5fr 1fr; } }

        .scrollable-admin-list { max-height: 400px; overflow-y: auto; border: 2px solid var(--border-glow-line); border-radius: 20px; padding: 25px; background: rgba(0,0,0,0.3); }
        .admin-row-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* --- Toast --- */
        #system-toast-container { position: fixed; bottom: 40px; left: 40px; z-index: 6000; right: auto; } /* Moved toast to Left */
        .toast-msg-vip { background: var(--gold-master); color: #000; padding: 20px 40px; border-radius: 15px; font-weight: 950; box-shadow: 0 20px 45px rgba(0,0,0,0.7); margin-top: 15px; display: flex; align-items: center; gap: 15px; animation: slideInRight 0.6s forwards; }

        .hidden { display: none !important; }

        /* --- Auth Portal --- */
        #auth-portal-mask { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; z-index: 9999; position: fixed; inset: 0; }
        .login-card-massive { width: 650px; padding: 100px 80px; text-align: center; border: 6px solid var(--gold-master); }

    </style>
</head>
<body>

    <!-- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ -->
    <div id="system-toast-container"></div>

    <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="master-dimmer" class="dimmer-overlay-master" onclick="closeSidebarControl()"></div>

    <!-- 
        ========================================================================
        --- AUTHENTICATION CORE PORTAL ---
        ========================================================================
    -->
    <div id="auth-portal-mask">
        <div class="massive-glass-card login-card-massive">
            <div class="identity-orb-vip" style="width:180px; height:180px; margin:0 auto 60px; font-size:6rem; cursor:default;">VIP</div>
            <h1 style="color:var(--gold-master); font-weight:950; font-size:4rem; margin-bottom:20px; letter-spacing:3px;">CENTRAL COMMAND</h1>
            <p style="color:var(--text-muted-core); margin-bottom:70px; font-weight:900; font-size:1.5rem;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„ÙØ§Ø¦Ù‚ V45.0</p>
            
            <input type="text" id="auth-uid-master" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (UID)">
            <input type="password" id="auth-pwd-master" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ù…Ø´ÙØ± (PWD)">
            
            <button class="btn-vip-execute-master" onclick="runSecurityAuthSequence()">ÙˆÙ„ÙˆØ¬ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© <i class="fas fa-shield-halved"></i></button>
        </div>
    </div>

    <!-- 
        ========================================================================
        --- MAIN MASTER INTERFACE ENGINE (SIDEBAR ARCHITECTURE) ---
        ========================================================================
    -->
    <div id="main-system-viewport" class="hidden">
        
        <!-- SIDEBAR NAVIGATION HUB -->
        <nav class="system-side-nav">
            <div class="identity-matrix">
                <div class="identity-orb-vip" id="ui-avatar-orb">V</div>
                <div class="identity-labels">
                    <h2 id="ui-user-fullname">---</h2>
                    <span id="ui-user-rank-label" style="display:block; margin-top:5px; color:var(--text-muted-core); font-size:0.9rem;">---</span>
                </div>
            </div>
            
            <div class="nav-hub-menu">
                <button class="nav-link-vip active" id="tab-live" onclick="switchToAppModule('live')"><i class="fas fa-satellite-dish"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                <button class="nav-link-vip" id="tab-daily" onclick="switchToAppModule('daily')"><i class="fas fa-calendar-check"></i> ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
                <button class="nav-link-vip" id="tab-archive" onclick="switchToAppModule('archive')"><i class="fas fa-database"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                <button class="nav-link-vip" id="tab-reports" onclick="switchToAppModule('reports')"><i class="fas fa-chart-line"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©</button>
                <button class="nav-link-vip hidden" id="tab-admin" onclick="switchToAppModule('admin')"><i class="fas fa-crown"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</button>
                
                <button class="nav-link-vip logout-btn-sidebar" onclick="runSystemLogoutSequence()">
                    <i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </nav>

        <!-- MAIN CONTENT CONTAINER -->
        <div class="vip-master-container">
            
            <!-- Floating Command Trigger (Left Side now) -->
            <button class="floating-action-master" id="floating-plus-btn" onclick="openSidebarControl()"><i class="fas fa-plus"></i></button>

            <!-- 
                ========================================================================
                --- MODULE: LIVE BROADCAST (Ø¨Ø« Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±) ---
                ========================================================================
            -->
            <div id="module-view-live">
                <h1 style="font-size:3rem; margin-bottom:40px; color:var(--text-pure); display:flex; align-items:center; gap:20px;">
                    <i class="fas fa-satellite-dish" style="color:var(--gold-master)"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
                </h1>
                <div id="render-live-feed-matrix" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(700px, 1fr)); gap:50px;"></div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: DAILY SNAPSHOT MATRIX (Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¬Ø¯Ø¯Ø© Ù„ÙƒÙ„ ØªØ§Ø±ÙŠØ®) ---
                ========================================================================
            -->
            <div id="module-view-daily" class="hidden">
                <div class="massive-glass-card" style="padding:80px; margin-bottom:80px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:80px;">
                        <div>
                            <h2 style="color:var(--gold-master); font-size:3.5rem; margin:0;"><i class="fas fa-calculator-combined"></i> Ù…Ø­Ø±Ùƒ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                            <p style="color:var(--text-muted-core); font-size:1.4rem; margin-top:20px;">Ø³Ø¬Ù„Ø§Øª Ù…Ù†ÙØµÙ„Ø© ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ÙƒÙ„ ØªØ§Ø±ÙŠØ®.</p>
                        </div>
                        <div style="width:350px; text-align:left;">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</label>
                            <input type="date" id="daily-master-date-picker" style="margin:0; font-size:1.4rem; font-weight:950;" onchange="loadDailySnapshotData()">
                        </div>
                    </div>
                    <!-- Ø´Ø¨ÙƒØ© Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                    <div id="render-daily-grid-hub" class="daily-matrix-display"></div>
                </div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: ARCHIVE HUB (Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ) ---
                ========================================================================
            -->
            <div id="module-view-archive" class="hidden">
                <div class="massive-glass-card" style="padding:60px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end;">
                    <div style="flex:1;"><label>Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archive-date-from" onchange="runArchiveRefreshSequence()"></div>
                    <div style="flex:1;"><label>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archive-date-to" onchange="runArchiveRefreshSequence()"></div>
                    <button class="btn-vip-execute-master" style="width:300px;" onclick="runArchiveRefreshSequence()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø´ÙŠÙ <i class="fas fa-rotate"></i></button>
                </div>
                <div id="render-archive-grid-hub" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(700px, 1fr)); gap:50px;"></div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: ANALYTICS COMMAND HUB (ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙØ§Ø¡Ø© ÙˆÙ…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£) ---
                ========================================================================
            -->
            <div id="module-view-reports" class="hidden">
                <div class="massive-glass-card" style="padding:50px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end;">
                    <div style="flex:1;"><label>ÙØªØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù†:</label><input type="date" id="reports-date-from"></div>
                    <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="reports-date-to"></div>
                    <button class="btn-vip-execute-master" style="width:250px;" onclick="executeAdvancedAnalyticsSequence()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ <i class="fas fa-brain"></i></button>
                    <button class="btn-vip-execute-master" style="width:200px; background:var(--accent-navy); color:white;" onclick="exportReportsToExcel()">Excel <i class="fas fa-file-excel"></i></button>
                </div>
                
                <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© -->
                <div id="render-analytics-stat-row" class="stat-cards-grid"></div>
                
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© -->
                <div class="analytics-dual-layout">
                    <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£) -->
                    <div class="massive-glass-card chart-viewport-massive">
                        <h3 style="color:var(--gold-master); font-size:2.2rem; margin-bottom:30px;">ğŸ“Š Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ 100 Ø£ÙˆØ±Ø¯Ø±</h3>
                        <p style="color:var(--text-muted-core); margin-bottom:30px; font-size:1.1rem;">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª.</p>
                        <canvas id="master-reports-canvas" style="max-height: 500px;"></canvas>
                    </div>

                    <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰) -->
                    <div class="massive-glass-card chart-viewport-massive">
                        <h3 style="color:var(--gold-master); font-size:2.2rem; margin-bottom:30px;">ğŸ“‰ ØªØ­Ù„ÙŠÙ„ ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h3>
                        <p style="color:var(--text-muted-core); margin-bottom:30px; font-size:1.1rem;">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ÙŠ Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨.</p>
                        <div style="height: 400px; display:flex; justify-content:center;">
                            <canvas id="master-types-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 
                ========================================================================
                --- MODULE: ADMIN CONTROL MATRIX (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©) ---
                ========================================================================
            -->
            <div id="module-view-admin" class="hidden">
                <div class="admin-layout-flex">
                    
                    <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© -->
                    <div class="massive-glass-card" style="padding:80px;">
                        <h3 style="color:var(--gold-master); font-size:2.4rem; margin-bottom:60px;"><i class="fas fa-store-slash"></i> Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø§ØªØµØ§Ù„Ø§Øª</h3>
                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                            <input id="adm-branch-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                            <button class="btn-vip-execute-master" style="width:180px;" onclick="addSystemBranchCore()">Ø¥Ø¯Ø±Ø§Ø¬</button>
                        </div>
                        <div id="adm-branches-scroll-box" class="scrollable-admin-list" style="margin-bottom:60px;"></div>
                        
                        <hr style="border:0; border-top:2px solid var(--border-glow-line); margin:50px 0;">
                        
                        <h3 style="color:var(--gold-master); font-size:2rem; margin-bottom:40px;"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                        <select id="adm-whatsapp-br-sel" onchange="renderBranchWhatsappList()"></select>
                        <div style="display:flex; gap:25px;">
                            <input id="adm-whatsapp-phone-input" placeholder="Ù…Ø«Ø§Ù„: 2010XXXXXXXX">
                            <button class="btn-vip-execute-master" style="width:180px; background:var(--success-glow); color:#000;" onclick="bindNewWhatsappToBranch()">+ Ø±Ø¨Ø·</button>
                        </div>
                        <div id="adm-whatsapp-scroll-box" class="scrollable-admin-list" style="margin-top:40px;"></div>
                    </div>

                    <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±ØªØ¨ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ø¨Ø´Ø±ÙŠØ© -->
                    <div class="massive-glass-card" style="padding:80px;">
                        <h3 style="color:var(--gold-master); font-size:2.4rem; margin-bottom:60px;"><i class="fas fa-shield-halved"></i> Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                            <input id="adm-rank-name-input" placeholder="Ø§Ø³Ù… Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                            <button class="btn-vip-execute-master" style="width:180px;" onclick="registerNewRankTitleCore()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <select id="adm-rank-matrix-sel" onchange="loadRankPermissionsMatrixHub()"></select>
                        <div id="adm-permissions-grid-hub" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; background:rgba(0,0,0,0.6); padding:40px; border-radius:20px; margin-top:35px; border:2px solid var(--border-glow-line);">
                            <label><input type="checkbox" id="perm-view-all"> Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø©</label>
                            <label><input type="checkbox" id="perm-create-ticket"> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§ØºØ§Øª</label>
                            <label><input type="checkbox" id="perm-reply-ticket"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø¯</label>
                            <label><input type="checkbox" id="perm-daily-edit"> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                            <label><input type="checkbox" id="perm-admin-access"> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                            <button class="btn-vip-execute-master" style="grid-column: span 2; margin-top:30px;" onclick="saveRankPermissionsSequence()">ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
                        </div>

                        <hr style="border:0; border-top:2px solid var(--border-glow-line); margin:60px 0;">
                        
                        <h3 style="color:var(--gold-master); font-size:2rem; margin-bottom:50px;">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶Ùˆ VIP</h3>
                        <input id="reg-user-id-core" placeholder="ÙƒÙˆØ¯ ID Ø§Ù„Ø¯Ø®ÙˆÙ„">
                        <input id="reg-user-fullname-core" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù">
                        <select id="reg-user-rank-sel-core"></select>
                        <select id="reg-user-branch-sel-core"></select>
                        <input id="reg-user-pass-core" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø©">
                        <button class="btn-vip-execute-master" onclick="registerNewUserToSystemSequence()">Ø¥Ø¯Ø±Ø§Ø¬ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</button>
                        <div id="adm-users-scroll-box" class="scrollable-admin-list" style="margin-top:50px;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 
        ========================================================================
        --- SIDEBAR: COMPLAINT ENTRY ENGINE (Opens from Left) ---
        ========================================================================
    -->
    <div id="sidebar-complaint-arc-hub" class="sidebar-complaint-master">
        <h2 style="color:var(--gold-master); font-size:3rem; margin-bottom:60px;"><i class="fas fa-file-signature"></i> ØªØ­Ø±ÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¨Ù„Ø§Øº VIP</h2>
        
        <label>ÙØ±Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ù†ÙŠ Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©</label>
        <select id="f-branch-master-sel"></select>
        
        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± (Order Identifier)</label>
        <input id="f-order-id-input" placeholder="#00000000">
        
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input id="f-customer-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        
        <label>ØªØµÙ†ÙŠÙ ÙˆØ·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„ÙÙ†ÙŠ</label>
        <select id="f-complaint-type-sel">
            <option>Ø£ÙˆØ±Ø¯Ø± Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option>
            <option>ØªØ£Ø®ÙŠØ± Ø­Ø§Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
            <option>Ø¬ÙˆØ¯Ø© Ø·Ø¹Ø§Ù… Ø³ÙŠØ¦Ø©</option>
            <option>Ø³ÙˆØ¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø·ÙŠØ§Ø±</option>
            <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        
        <label>Ø§Ø³Ù… ÙƒØ§Ø¨ØªÙ† Ø§Ù„ØªÙˆØµÙŠÙ„</label>
        <input id="f-driver-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±">
        
        <label>Ù†Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© Ø¨Ø¯Ù‚Ø©</label>
        <textarea id="f-complaint-msg-input" rows="8" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø¯Ù‚Ø© Ù‡Ù†Ø§ Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§..."></textarea>
        
        <button class="btn-vip-execute-master" id="submit-complaint-btn" onclick="runComplaintTicketSequence()">ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº ÙÙˆØ±Ø§Ù‹ <i class="fab fa-whatsapp"></i></button>
    </div>

    <!-- 
        ========================================================================
        --- JAVASCRIPT MASTER CORE ENGINE V45.0 ---
        ========================================================================
    -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        /* 
           ========================================================================
           --- INTERNAL CORE LOGIC: VIP INFINITE INTELLIGENCE --- 
           ========================================================================
        */
        const firebaseConfig = {
            apiKey: "AIzaSyBSwsheoAEJm3pLMI8lhVvzFnLS-a4FrVA",
            authDomain: "break2-5de32.firebaseapp.com",
            databaseURL: "https://break2-5de32-default-rtdb.firebaseio.com",
            projectId: "break2-5de32",
            storageBucket: "break2-5de32.firebasestorage.app",
            messagingSenderId: "864134684796",
            appId: "1:864134684796:web:078af20f713c95a08be9f9"
        };
        firebase.initializeApp(firebaseConfig);
        const dbHub = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global System State)
        let currentUserSession = null;
        let complaintsCache = {};
        let systemSettingsCache = {};
        let branchListCache = [];
        let analyticsChartInstance = null;
        let analyticsTypeChartInstance = null;

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ
         */
        async function runSecurityAuthSequence() {
            const uid = document.getElementById('auth-uid-master').value.trim();
            const pwd = document.getElementById('auth-pwd-master').value.trim();

            if(!uid || !pwd) {
                renderSystemToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ„ÙˆØ¬ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©!", "danger");
                return;
            }

            if(uid === 'super' && pwd === 'vip2026') {
                grantCoreAccess({id:'super', name:'Super Administrator', title:'ROOT-COMMAND', branch:'ALL', role:'SUPER'});
                return;
            }

            const snap = await dbHub.ref('users/' + uid).get();
            if(snap.exists() && snap.val().pass === pwd) {
                grantCoreAccess({id: uid, ...snap.val()});
            } else {
                Swal.fire('Ø§Ø®ØªØ±Ø§Ù‚ Ø£Ù…Ù†ÙŠ Ø£Ùˆ Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø³Ø¬Ù„Ø§ØªÙ†Ø§.', 'error');
            }
        }

        function grantCoreAccess(data) {
            localStorage.setItem('vip_v43_secure_token', JSON.stringify(data));
            location.reload();
        }

        function runSystemLogoutSequence() {
            localStorage.removeItem('vip_v43_secure_token');
            location.reload();
        }

        /**
         * ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
         */
        window.onload = () => {
            const sess = localStorage.getItem('vip_v43_secure_token');
            if(sess) {
                currentUserSession = JSON.parse(sess);
                document.getElementById('auth-portal-mask').classList.add('hidden');
                document.getElementById('main-system-viewport').classList.remove('hidden');
                document.getElementById('ui-user-fullname').innerText = currentUserSession.name;
                document.getElementById('ui-user-rank-label').innerText = currentUserSession.title;
                document.getElementById('ui-avatar-orb').innerText = currentUserSession.name.charAt(0);
                
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('daily-master-date-picker').value = todayStr;
                document.getElementById('archive-date-from').value = todayStr;
                document.getElementById('archive-date-to').value = todayStr;
                document.getElementById('reports-date-from').value = todayStr;
                document.getElementById('reports-date-to').value = todayStr;

                initCoreDataListeners();
            }
        };

        /**
         * Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
         */
        function initCoreDataListeners() {
            dbHub.ref('settings').on('value', snap => {
                systemSettingsCache = snap.val() || {};
                branchListCache = systemSettingsCache.branches ? Object.values(systemSettingsCache.branches) : [];
                syncUiDropdownSelections();
                renderAdminBranchScrollBox();
                renderAdminUsersScrollBox();
                renderBranchWhatsappList();
                loadDailySnapshotData(); 
                runPermissionShieldCheck();
            });

            dbHub.ref('operations').on('value', snap => {
                complaintsCache = snap.val() || {};
                renderLiveBroadcastMatrix(); 
                runArchiveRefreshSequence();
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
         */
        async function loadDailySnapshotData() {
            const dateStr = document.getElementById('daily-master-date-picker').value;
            const gridBox = document.getElementById('render-daily-grid-hub');
            gridBox.innerHTML = `<h2 style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 120px;">Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù…ØµÙÙˆÙØ© Ø³Ø¬Ù„Ø§Øª ÙŠÙˆÙ… ${dateStr}...</h2>`;

            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canEdit = p.daily_edit || currentUserSession.role === 'SUPER';
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            const dSnap = await dbHub.ref(`daily_stats/${dateStr}`).get();
            const dailyData = dSnap.val() || {};
            
            gridBox.innerHTML = "";
            branchListCache.forEach(branch => {
                if(!canSeeAll && branch !== currentUserSession.branch) return;

                gridBox.innerHTML += `
                    <div class="massive-glass-card branch-data-card">
                        <h4 style="font-size: 2.5rem; margin: 0;">${branch}</h4>
                        <input type="number" class="massive-daily-input" 
                               value="${dailyData[branch] || 0}" 
                               ${canEdit ? '' : 'disabled'} 
                               onchange="commitDailyOrderValue('${dateStr}', '${branch}', this.value)">
                        <div style="font-size: 1.2rem; color: var(--text-muted-core); margin-top: 30px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª ÙŠÙˆÙ… ${dateStr}</div>
                    </div>`;
            });
        }

        async function commitDailyOrderValue(date, br, val) {
            if(val < 0) { renderSystemToast("Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ù„Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©!", "danger"); return; }
            await dbHub.ref(`daily_stats/${date}/${br}`).set(val);
            renderSystemToast(`ØªÙ… Ø­ÙØ¸ Ø£ÙˆØ±Ø¯Ø±Ø§Øª ${br} Ù„ÙŠÙˆÙ… ${date}`, "success");
        }

        /**
         * Ù…Ø­Ø±Ùƒ ØªØ­Ø±ÙŠØ± ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª
         */
        async function runComplaintTicketSequence() {
            const br = document.getElementById('f-branch-master-sel').value;
            const ord = document.getElementById('f-order-id-input').value.trim();
            const cust = document.getElementById('f-customer-name-input').value.trim();
            const type = document.getElementById('f-complaint-type-sel').value;
            const drv = document.getElementById('f-driver-name-input').value.trim();
            const msg = document.getElementById('f-complaint-msg-input').value.trim();

            if(!ord || !cust || !msg) {
                Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡.', 'warning');
                return;
            }

            const timeNow = new Date().toLocaleTimeString('ar-EG');
            const dateNow = new Date().toISOString().split('T')[0];

            const ticketData = {
                branch: br, order: ord, customer: cust, type: type, 
                msg: msg, driver: drv,
                stage: 'waiting_review', status: 'active',
                timestamp: new Date().toLocaleString('ar-EG'), timeOnly: timeNow, date: dateNow,
                author: currentUserSession.name,
                logs: [{ time: timeNow, user: currentUserSession.name, action: "ØªØ­Ø±ÙŠØ± Ø¨Ù„Ø§Øº VIP ÙˆØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©." }]
            };

            await dbHub.ref('operations').push(ticketData);
            triggerBranchBroadcast(br, ord, cust, type, msg, timeNow);
            closeSidebarControl();
            renderSystemToast("ØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            
            ['f-order-id-input','f-customer-name-input','f-complaint-msg-input','f-driver-name-input'].forEach(id => document.getElementById(id).value = '');
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¨Ø« Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
         */
        async function triggerBranchBroadcast(br, ord, cust, type, msg, time) {
            const pMap = systemSettingsCache.phones ? (systemSettingsCache.phones[br] || {}) : {};
            const pList = Object.values(pMap);
            if(pList.length === 0) return;

            const text = `ğŸš¨ *Ø¨Ù„Ø§Øº VIP Ø¬Ø¯ÙŠØ¯* ğŸš¨\n\nğŸ“ Ø§Ù„ÙØ±Ø¹: ${br}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${time}\nğŸ”¢ Ø§Ù„Ø·Ù„Ø¨: ${ord}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${cust}\nğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹: ${type}\nğŸ“ Ø§Ù„Ø´ÙƒÙˆÙ‰: ${msg}\nğŸ‘· Ø§Ù„Ù…ØªÙ„Ù‚ÙŠ Ø¨Ø§Ù„ÙØ±Ø¹: ${currentUserSession.name}`;
            
            pList.forEach(ph => {
                fetch(`https://api.ultramsg.com/instance157671/messages/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({'token': 'cpx85mx613v868fe', 'to': ph, 'body': text})
                });
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
         */
        function renderLiveBroadcastMatrix() {
            const box = document.getElementById('render-live-feed-matrix');
            box.innerHTML = "";
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            Object.keys(complaintsCache).reverse().forEach(id => {
                const op = complaintsCache[id];
                if(op.status === 'done') return; 
                if(!canSeeAll && op.branch !== currentUserSession.branch) return;

                box.innerHTML += generateTicketMarkup(id, op, true, p);
            });
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
         */
        function runArchiveRefreshSequence() {
            const box = document.getElementById('render-archive-grid-hub');
            if(!box) return;
            box.innerHTML = "";
            const from = document.getElementById('archive-date-from').value;
            const to = document.getElementById('archive-date-to').value;
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            Object.keys(complaintsCache).reverse().forEach(id => {
                const op = complaintsCache[id];
                if(op.status !== 'done') return;
                if(!canSeeAll && op.branch !== currentUserSession.branch) return;
                if(op.date < from || op.date > to) return;

                box.innerHTML += generateTicketMarkup(id, op, false, p);
            });
        }

        /**
         * Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨ØµØ±ÙŠ
         */
        function generateTicketMarkup(id, op, isInteractive, p) {
            let btns = "";
            if(isInteractive) {
                if(op.stage === 'waiting_review' && (p.reply_ticket || currentUserSession.role === 'SUPER')) {
                    btns = `<button class="btn-vip-execute-master" style="background:var(--success-glow); color:#000;" onclick="openBranchReplyModalHub('${id}')">Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© <i class="fas fa-reply-all"></i></button>`;
                } else if(op.stage === 'replied' && (currentUserSession.title === 'Ø¯ÙŠØ³Ø¨ØªØ´Ø±' || currentUserSession.role === 'SUPER')) {
                    btns = `<button class="btn-vip-execute-master" onclick="finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø±Ø´ÙŠÙ</button>`;
                }
            }

            const logs = op.logs ? op.logs.map(l => `
                <div class="audit-row-item">
                    <b>${l.user}:</b> ${l.action}
                    <span class="timestamp-label">${l.time}</span>
                </div>`).join('') : '';

            const badge = op.branch_verdict === 'Ù†Ø§Ù‚Øµ' ? 
                '<span class="badge-status-glow" style="background:rgba(239, 68, 68, 0.2); color:var(--danger-pulse); border:2px solid var(--danger-pulse);">ØªØ£ÙƒÙŠØ¯ Ù†Ù‚Øµ ÙØ¹Ù„ÙŠ âŒ</span>' : 
                (op.branch_verdict === 'ÙƒØ§Ù…Ù„' ? '<span class="badge-status-glow" style="background:rgba(16, 185, 129, 0.2); color:var(--success-glow); border:2px solid var(--success-glow);">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙƒØ§Ù…Ù„ ÙˆØ³Ù„ÙŠÙ… âœ…</span>' : '');

            return `
                <div class="massive-glass-card ticket-visual-unit">
                    <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
                        <b style="color:var(--gold-master); font-size:2rem;">ğŸ“ ÙØ±Ø¹ : ${op.branch}</b>
                        <span style="opacity:0.7; font-weight:900;">${op.timestamp}</span>
                    </div>
                    ${badge}
                    <div style="font-size:3rem; font-weight:950; margin-bottom:25px;">ğŸ“¦ Ø£ÙˆØ±Ø¯Ø±: #${op.order}</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; margin-bottom:25px; color:var(--accent-navy); font-weight:950; font-size:1.4rem;">
                        <span>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${op.customer}</span>
                        <span>ğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹: ${op.type}</span>
                    </div>
                    <div style="color:var(--success-glow); font-weight:950; margin-bottom:25px; font-size:1.4rem;">ğŸ‘¨â€âœˆï¸ Ø§Ù„Ø·ÙŠØ§Ø±: ${op.driver || '---'}</div>
                    <p style="background:rgba(0,0,0,0.65); padding:30px; border-radius:20px; border:2px solid rgba(255,255,255,0.1); font-size:1.4rem; line-height:1.8;">ğŸ“ ${op.msg}</p>
                    <div class="audit-logs-viewport">${logs}</div>
                    <div style="margin-top:40px;">${btns}</div>
                </div>`;
        }

        /**
         * Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ù…Ø·ÙˆØ±
         */
        async function executeAdvancedAnalyticsSequence() {
            const from = document.getElementById('reports-date-from').value;
            const to = document.getElementById('reports-date-to').value;
            const ops = Object.values(complaintsCache).filter(o => o.date >= from && o.date <= to);
            
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

            const resolved = ops.filter(o => o.status === 'done').length;
            document.getElementById('render-analytics-stat-row').innerHTML = `
                <div class="analytics-pill-card" style="border-top: 12px solid var(--gold-master)"><h2>${ops.length}</h2><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--success-glow)"><h2>${resolved}</h2><p>Ø¨Ù„Ø§ØºØ§Øª Ù…ØºÙ„Ù‚Ø©</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--danger-pulse)"><h2>${ops.length - resolved}</h2><p>Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</p></div>
                <div class="analytics-pill-card" style="border-top: 12px solid var(--accent-navy)"><h2>${ops.length ? Math.round((resolved/ops.length)*100) : 0}%</h2><p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p></div>
            `;

            // 1. Chart 1: Error Rate Bar Chart
            const dSnap = await dbHub.ref('daily_stats').get();
            const allDays = dSnap.val() || {};
            const labels = [];
            const complaintsCounts = [];
            const ordersCounts = [];
            const ratios = [];

            branchListCache.forEach(br => {
                if(!canSeeAll && br !== currentUserSession.branch) return;
                labels.push(br);
                const brComplaints = ops.filter(o => o.branch === br).length;
                let brOrders = 0;
                Object.keys(allDays).forEach(day => {
                    if(day >= from && day <= to && allDays[day][br]) brOrders += parseInt(allDays[day][br]);
                });
                complaintsCounts.push(brComplaints);
                ordersCounts.push(brOrders);
                ratios.push(brOrders > 0 ? ((brComplaints / brOrders) * 100).toFixed(2) : 0);
            });

            if(analyticsChartInstance) analyticsChartInstance.destroy();
            analyticsChartInstance = new Chart(document.getElementById('master-reports-canvas'), {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ %', 
                        data: ratios, 
                        backgroundColor: '#f59e0b', 
                        borderRadius: 15,
                        customComplaints: complaintsCounts,
                        customOrders: ordersCounts
                    }] 
                },
                options: { 
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: '#fff' } }, 
                        x: { ticks: { color: '#fff' } } 
                    },
                    plugins: { 
                        legend: { labels: { color: '#fff', font: {size: 14} } },
                        datalabels: { 
                            anchor: 'end', align: 'top', color: '#fff', font: { weight: 'bold', size: 12 },
                            formatter: (value, ctx) => `Ø´: ${ctx.dataset.customComplaints[ctx.dataIndex]} | Ø£: ${ctx.dataset.customOrders[ctx.dataIndex]}\n(${value}%)`,
                            textAlign: 'center'
                        }
                    }
                }
            });

            // 2. Chart 2: Type Analysis (Pie/Doughnut)
            const typeCounts = {};
            let filteredOpsForType = canSeeAll ? ops : ops.filter(o => o.branch === currentUserSession.branch);
            filteredOpsForType.forEach(o => { const t = o.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; typeCounts[t] = (typeCounts[t] || 0) + 1; });

            const typeLabels = Object.keys(typeCounts);
            const typeValues = Object.values(typeCounts);
            const totalComplaints = typeValues.reduce((a, b) => a + b, 0);
            const pieColors = ['#f59e0b', '#ef4444', '#10b981', '#1d4ed8', '#8b5cf6', '#ec4899', '#6366f1'];

            if(analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();
            analyticsTypeChartInstance = new Chart(document.getElementById('master-types-canvas'), {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: {
                    labels: typeLabels,
                    datasets: [{ data: typeValues, backgroundColor: pieColors, borderColor: '#000', borderWidth: 2, hoverOffset: 10 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#fff', font: { size: 12 }, padding: 15 } },
                        datalabels: {
                            color: '#000', font: { weight: 'bold', size: 12 },
                            formatter: (value) => ((value / totalComplaints) * 100).toFixed(1) + "%",
                            backgroundColor: 'rgba(255, 255, 255, 0.8)', borderRadius: 5, padding: 5
                        }
                    }
                }
            });
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥ÙƒØ³Ù„
         */
        function exportReportsToExcel() {
            const from = document.getElementById('reports-date-from').value;
            const to = document.getElementById('reports-date-to').value;
            const ops = Object.values(complaintsCache).filter(o => o.date >= from && o.date <= to);
            
            const list = ops.map(o => ({
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº': o.date,
                'ÙˆÙ‚Øª Ø§Ù„Ø¨Ù„Ø§Øº': o.timeOnly,
                'Ø§Ù„ÙØ±Ø¹': o.branch,
                'Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±': o.order,
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': o.customer,
                'Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰': o.type,
                'Ø§Ù„Ø­Ø§Ù„Ø©': o.status === 'done' ? 'Ù…ØºÙ„Ù‚' : 'Ù†Ø´Ø·',
                'Ø§Ù„Ù†ØªÙŠØ¬Ø©': o.branch_verdict || '---',
                'Ø§Ù„Ù…Ø­Ø±Ø±': o.author
            }));

            const ws = XLSX.utils.json_to_sheet(list);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "VIP_Report");
            XLSX.writeFile(wb, `VIP_Analytics_${from}_to_${to}.xlsx`);
        }

        /**
         * Ø±Ø¯ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ
         */
        async function openBranchReplyModalHub(id) {
            const { value: res } = await Swal.fire({
                title: 'Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„ÙØ±Ø¹',
                html: `<select id="sw-status" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ø§Ù„Ø·Ù„Ø¨ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹ (Ø§Ø¹ØªØ±Ø§Ù Ø¨Ø§Ù„Ø®Ø·Ø£)</option></select>
                       <textarea id="sw-msg" class="swal2-input" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙ…Ø§ ØªÙ… Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>`,
                preConfirm: () => [document.getElementById('sw-status').value, document.getElementById('sw-msg').value]
            });

            if(res) {
                const op = complaintsCache[id];
                const action = res[0] === 'Ù†Ø§Ù‚Øµ' ? `Ø§Ù„ÙØ±Ø¹ ÙŠØ¤ÙƒØ¯: [Ù†Ù‚Øµ ÙØ¹Ù„ÙŠ âš ï¸] - ${res[1]}` : `Ø±Ø¯ Ø§Ù„ÙØ±Ø¹: [Ø§Ù„Ø·Ù„Ø¨ Ø³Ù„ÙŠÙ…] - ${res[1]}`;
                const log = { time: new Date().toLocaleTimeString('ar-EG'), user: currentUserSession.name, action: action };
                
                await dbHub.ref('operations/'+id).update({ stage: 'replied', branch_verdict: res[0], logs: [...(op.logs || []), log] });
                renderSystemToast("ØªÙ… ØªØ«Ø¨ÙŠØª Ø±Ø¯ Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            }
        }

        async function finalizeTicketAndArchive(id) {
            const op = complaintsCache[id];
            const log = { time: new Date().toLocaleTimeString('ar-EG'), user: currentUserSession.name, action: "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ." };
            await dbHub.ref('operations/'+id).update({ status: 'done', logs: [...(op.logs || []), log] });
            renderSystemToast("ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }

        /**
         * Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª
         */
        function syncUiDropdownSelections() {
            const html = branchListCache.map(b => `<option>${b}</option>`).join('');
            document.getElementById('f-branch-master-sel').innerHTML = html;
            document.getElementById('adm-whatsapp-br-sel').innerHTML = html;
            document.getElementById('reg-user-branch-sel-core').innerHTML = `<option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>` + html;
            
            const ranks = systemSettingsCache.custom_ranks ? Object.keys(systemSettingsCache.custom_ranks) : ['Ø¯ÙŠØ³Ø¨ØªØ´Ø±', 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹'];
            const rHtml = ranks.map(r => `<option>${r}</option>`).join('');
            document.getElementById('adm-rank-matrix-sel').innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ø±ØªØ¨Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØµÙÙˆÙØªÙ‡Ø§ --</option>` + rHtml;
            document.getElementById('reg-user-rank-sel-core').innerHTML = rHtml;
        }

        function renderAdminBranchScrollBox() {
            const box = document.getElementById('adm-branches-scroll-box'); box.innerHTML = "";
            const brs = systemSettingsCache.branches || {};
            Object.keys(brs).forEach(k => {
                box.innerHTML += `
                    <div class="admin-row-item">
                        <span><i class="fas fa-building" style="color:var(--gold-master)"></i> ${brs[k]}</span>
                        <i class="fas fa-trash-alt" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('settings/branches/${k}').remove()"></i>
                    </div>`;
            });
        }

        async function addSystemBranchCore() {
            const n = document.getElementById('adm-branch-name-input').value.trim();
            if(n) await dbHub.ref('settings/branches').push(n);
            document.getElementById('adm-branch-name-input').value = "";
        }

        function renderBranchWhatsappList() {
            const br = document.getElementById('adm-whatsapp-br-sel').value;
            const box = document.getElementById('adm-whatsapp-scroll-box'); box.innerHTML = "";
            const p = systemSettingsCache.phones ? (systemSettingsCache.phones[br] || {}) : {};
            Object.keys(p).forEach(k => box.innerHTML += `
                <div class="admin-row-item">
                    <span>${p[k]}</span>
                    <i class="fas fa-trash" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('settings/phones/${br}/${k}').remove()"></i>
                </div>`);
        }

        async function bindNewWhatsappToBranch() {
            const br = document.getElementById('adm-whatsapp-br-sel').value;
            const ph = document.getElementById('adm-whatsapp-phone-input').value.trim();
            if(ph) await dbHub.ref(`settings/phones/${br}`).push(ph);
            document.getElementById('adm-whatsapp-phone-input').value = "";
        }

        function loadRankPermissionsMatrixHub() {
            const r = document.getElementById('adm-rank-matrix-sel').value;
            if(!r) { document.getElementById('adm-permissions-grid-hub').classList.add('hidden'); return; }
            document.getElementById('adm-permissions-grid-hub').classList.remove('hidden');
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[r] || {}) : {};
            document.getElementById('perm-view-all').checked = p.view_all || false;
            document.getElementById('perm-create-ticket').checked = p.create_ticket || false;
            document.getElementById('perm-reply-ticket').checked = p.reply_ticket || false;
            document.getElementById('perm-daily-edit').checked = p.daily_edit || false;
            document.getElementById('perm-admin-access').checked = p.admin_access || false;
        }

        async function saveRankPermissionsSequence() {
            const r = document.getElementById('adm-rank-matrix-sel').value;
            const data = {
                view_all: document.getElementById('perm-view-all').checked,
                create_ticket: document.getElementById('perm-create-ticket').checked,
                reply_ticket: document.getElementById('perm-reply-ticket').checked,
                daily_edit: document.getElementById('perm-daily-edit').checked,
                admin_access: document.getElementById('perm-admin-access').checked
            };
            await dbHub.ref('settings/permissions/'+r).set(data);
            renderSystemToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.", "success");
        }

        function renderAdminUsersScrollBox() {
            const box = document.getElementById('adm-users-scroll-box'); box.innerHTML = "";
            dbHub.ref('users').once('value', snap => {
                const u = snap.val() || {};
                Object.keys(u).forEach(uid => {
                    const user = u[uid];
                    box.innerHTML += `
                        <div class="admin-row-item">
                            <div>
                                <b style="color:var(--gold-master)">${user.name}</b> <small>(${user.title})</small>
                                <div style="font-size: 0.8rem; color: var(--text-muted-core)">ID: ${uid} | Ø§Ù„ÙØ±Ø¹: ${user.branch}</div>
                            </div>
                            <i class="fas fa-user-minus" style="color:var(--danger-pulse); cursor:pointer;" onclick="dbHub.ref('users/${uid}').remove().then(()=>renderAdminUsersScrollBox())"></i>
                        </div>`;
                });
            });
        }

        async function registerNewUserToSystemSequence() {
            const id = document.getElementById('reg-user-id-core').value.trim();
            const data = {
                name: document.getElementById('reg-user-fullname-core').value,
                title: document.getElementById('reg-user-rank-sel-core').value,
                branch: document.getElementById('reg-user-branch-sel-core').value,
                pass: document.getElementById('reg-user-pass-core').value
            };
            if(id && data.name) await dbHub.ref('users/'+id).set(data).then(()=>renderAdminUsersScrollBox());
            renderSystemToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù.", "success");
        }

        function registerNewRankTitleCore() {
            const t = document.getElementById('adm-rank-name-input').value.trim();
            if(t) dbHub.ref('settings/custom_ranks/'+t).set(true);
            document.getElementById('adm-rank-name-input').value = "";
        }

        function runPermissionShieldCheck() {
            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
            if(p.admin_access || currentUserSession.role === 'SUPER') document.getElementById('tab-admin').classList.remove('hidden');
            const canAdd = p.create_ticket || currentUserSession.role === 'SUPER';
            document.getElementById('floating-plus-btn').className = canAdd ? 'floating-action-master' : 'hidden';
        }

        /**
         * Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         */
        function openSidebarControl() {
            const sb = document.getElementById('sidebar-complaint-arc-hub');
            sb.classList.add('open');
            document.getElementById('master-dimmer').style.display = 'block';
        }

        function closeSidebarControl() {
            const sb = document.getElementById('sidebar-complaint-arc-hub');
            sb.classList.remove('open');
            document.getElementById('master-dimmer').style.display = 'none';
        }

        function switchToAppModule(m) {
            document.querySelectorAll('.nav-link-vip').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + m).classList.add('active');
            
            ['live', 'daily', 'archive', 'reports', 'admin'].forEach(id => {
                document.getElementById('module-view-' + id).classList.add('hidden');
            });
            document.getElementById('module-view-' + m).classList.remove('hidden');

            if(m === 'reports') executeAdvancedAnalyticsSequence();
            if(m === 'daily') loadDailySnapshotData();
        }

        function renderSystemToast(m, type) {
            const box = document.getElementById('system-toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-msg-vip';
            if(type === 'danger') toast.style.background = '#ef4444';
            toast.innerHTML = `<i class="fas ${type === 'danger' ? 'fa-triangle-exclamation' : 'fa-circle-check'}"></i> ${m}`;
            box.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

    </script>
</body>
</html>
